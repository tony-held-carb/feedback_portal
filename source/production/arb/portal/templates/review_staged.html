{% extends "base.html" %}
{% block content_1 %}

<!-- DataTables Styles & Scripts -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
  thead.review-header {
    position: sticky;
    top: 70px;
    z-index: 9;
    background-color: #245a9a;
    color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  thead.review-header th {
    text-align: center;
    vertical-align: middle;
    font-weight: 600;
    padding: 0.5rem;
    background-color: #245a9a;
    color: white;
  }

  thead.review-header::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: #245a9a;
    z-index: -1;
  }

  table.review-table th,
  table.review-table td {
    vertical-align: middle;
  }

  th.confirm-th {
    width: 1%;
    text-align: center;
  }

  th.confirm-th .confirm-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  table.review-table {
    margin-top: 0;
  }
</style>

<div class="container my-4">
  <h2 class="mb-4">üßæ Review Staged Upload</h2>

  <div class="mb-3">
    {% if is_new_row %}
      <strong class="text-primary">üÜï New Incidence ID:</strong> {{ id_incidence }}
    {% else %}
      <strong class="text-warning">üìÅ Existing Incidence ID:</strong> {{ id_incidence }}
    {% endif %}
  </div>

  <div class="alert alert-info small mb-3">
    <strong>Note:</strong> For fields that would overwrite existing data, you must check the <strong>Confirm</strong> box to approve the change.
    Unchecked fields will not be updated.
  </div>

  <div class="row g-2 mb-3 align-items-center">
    <div class="col-auto">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="hideUnchangedFields">
        <label class="form-check-label" for="hideUnchangedFields">Hide unchanged fields</label>
      </div>
    </div>
    <div class="col">
      <input type="text" class="form-control" id="fieldSearch" placeholder="üîç Filter fields by name or value">
    </div>
  </div>

  <form method="POST" action="{{ url_for('main.confirm_staged', id_=id_incidence) }}">
    <table id="review-table" class="table table-sm table-striped table-bordered table-hover review-table">
      <thead class="review-header">
        <tr>
          <th class="confirm-th">
            <div class="confirm-header">
              <span>Confirm</span>
              <input class="form-check-input" type="checkbox" id="selectAllConfirmations" title="Toggle all confirmations">
            </div>
          </th>
          <th>Key</th>
          <th>Old Value (DB)</th>
          <th>New Value (Upload)</th>
        </tr>
      </thead>
      <tbody>
        {% for field in staged_fields %}
          {% set changed = field.changed %}
          <tr class="field-row {% if not changed %}unchanged-field{% else %}table-warning{% endif %}">
            <td class="text-center">
              {% if field.requires_confirmation %}
                <input type="checkbox" name="confirm_overwrite_{{ field.key }}" class="confirm-checkbox">
              {% else %}
                ‚Äî
              {% endif %}
            </td>
            <td>{{ field.key }}</td>
            <td>{{ field.old }}</td>
            <td>
              {% if changed %}
                <mark>{{ field.new }}</mark>
              {% else %}
                {{ field.new }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-end mt-4">
      <button type="submit" class="btn btn-success btn-lg">
        ‚úÖ Confirm and Save Upload
      </button>
    </div>
  </form>
</div>

<script>
  let table;

  document.addEventListener("DOMContentLoaded", function () {
    table = $('#review-table').DataTable({
      paging: false,
      info: false,
      searching: false,
      ordering: true,
      stripeClasses: ['table-light', 'table-secondary'],
      columnDefs: [{ orderable: false, targets: 0 }]
    });

    // Custom filtering for unchanged rows and search string
    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
      const hideUnchanged = document.getElementById("hideUnchangedFields").checked;
      const query = document.getElementById("fieldSearch").value.toLowerCase();
      const rowNode = table.row(dataIndex).node();

      if (!rowNode) return true;

      const isUnchanged = rowNode.classList.contains("unchanged-field");
      const matches = rowNode.innerText.toLowerCase().includes(query);

      return (!hideUnchanged || !isUnchanged) && matches;
    });

    // Bind redraw triggers
    document.getElementById("hideUnchangedFields").addEventListener("change", () => {
      table.draw();
    });

    document.getElementById("fieldSearch").addEventListener("input", () => {
      table.draw();
    });

    // Confirm checkbox management
    const selectAllBox = document.getElementById("selectAllConfirmations");

    function updateConfirmAllState() {
      const checkboxes = document.querySelectorAll(".confirm-checkbox");
      const checkedCount = [...checkboxes].filter(cb => cb.checked).length;
      selectAllBox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
      selectAllBox.checked = checkedCount === checkboxes.length;
    }

    selectAllBox.addEventListener("change", function () {
      document.querySelectorAll(".confirm-checkbox").forEach(cb => cb.checked = this.checked);
      updateConfirmAllState();
    });

    document.querySelectorAll(".confirm-checkbox").forEach(cb => {
      cb.addEventListener("change", updateConfirmAllState);
    });

    updateConfirmAllState();
    table.draw();  // Apply initial filtering
  });
</script>

{% endblock %}
