{% extends "base.html" %}

{% block content_1 %}

<div class="container my-4">
  <h2 class="mb-4">🧾 Review Staged Upload</h2>

  <div class="mb-3">
    <strong>Incidence ID:</strong> {{ id_incidence }}<br>
    <strong>Is New Row:</strong> {{ is_new_row }}<br>
    <strong>Metadata:</strong>
    <pre class="bg-light p-2 border rounded">{{ metadata | tojson(indent=2) }}</pre>
  </div>

  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="showAllFields" checked>
    <label class="form-check-label" for="showAllFields">Show all fields (including unchanged)</label>
  </div>

  <input type="text" class="form-control mb-3" id="fieldSearch" placeholder="🔍 Filter fields by name or value">

  <form method="POST" action="{{ url_for('main.confirm_staged', id_=id_incidence) }}">
    <table class="table table-bordered table-hover">
      <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
        <tr>
          <th>Key</th>
          <th>Old Value (DB)</th>
          <th>New Value (Upload)</th>
        </tr>
      </thead>
      <tbody>
        {% for field in staged_fields %}
          {% set changed = field.changed %}
          <tr class="field-row {% if not changed %}unchanged-field{% else %}table-warning{% endif %}">
            <td>
              {{ field.key }}
              {% if field.from_upload %}
                <br><span class="badge bg-primary">from_upload</span>
              {% endif %}
            </td>
            <td>{{ field.old }}</td>
            <td>
              {% if changed %}
                <mark>{{ field.new }}</mark>
              {% else %}
                {{ field.new }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-end mt-4">
      <button type="submit" class="btn btn-success btn-lg">
        ✅ Confirm and Save Upload
      </button>
    </div>
  </form>
</div>

<script>
  // Toggle visibility of unchanged rows
  document.getElementById("showAllFields").addEventListener("change", function () {
    const show = this.checked;
    document.querySelectorAll(".unchanged-field").forEach(row => {
      row.style.display = show ? "" : "none";
    });
  });

  // Live search by field name or values
  document.getElementById("fieldSearch").addEventListener("input", function () {
    const q = this.value.toLowerCase();
    document.querySelectorAll("tbody tr").forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(q) ? "" : "none";
    });
  });

  // Scroll to first changed field on load
  window.addEventListener('DOMContentLoaded', () => {
    const changedRow = document.querySelector('.table-warning');
    if (changedRow) changedRow.scrollIntoView({ behavior: 'smooth' });
  });
</script>

{% endblock %}
