{% extends "base.html" %}
{% block content %}

<h2 class="mt-3">Review Staged Upload</h2>
<p class="lead">Review the staged upload contents below for ID <strong>{{ id_incidence }}</strong>.</p>

<!-- Metadata Summary -->
<div class="card my-3">
  <div class="card-body">
    <h5 class="card-title">Upload Metadata</h5>
    <ul class="mb-0">
      <li><strong>Filename:</strong> {{ id_incidence }}.json</li>
      <li><strong>Upload Timestamp:</strong> {{ metadata.get("timestamp", "Unknown") }}</li>
      <li><strong>Sector:</strong> {{ metadata.get("sector", "Unknown") }}</li>
      <li><strong>New Record?:</strong> {{ "Yes" if is_new_row else "No" }}</li>
      <li><strong>Changes Detected:</strong> {{ diffs|length }}</li>
    </ul>
  </div>
</div>

<!-- Action Buttons -->
<div class="mb-3">
  <form method="POST" action="{{ url_for('main.apply_staged_update', id_=id_incidence) }}" class="d-inline">
    <button type="submit" class="btn btn-success">‚úÖ Approve & Commit</button>
  </form>

  <form method="POST" action="{{ url_for('main.discard_staged_update', id_=id_incidence) }}" class="d-inline ms-2">
    <button type="submit" class="btn btn-danger">üóëÔ∏è Discard Staged Data</button>
  </form>

  <div class="form-check form-switch d-inline ms-4">
    <input class="form-check-input" type="checkbox" role="switch" id="showAllFields">
    <label class="form-check-label" for="showAllFields">Show all fields</label>
  </div>
</div>

<!-- Table of Differences -->
<table class="table table-bordered mt-3">
  <thead>
    <tr>
      <th>Field</th>
      <th>Old Value</th>
      <th>New Value</th>
    </tr>
  </thead>
  <tbody>
    {% for field in all_fields %}
      {% set changed = field.changed %}
      <tr class="{{ '' if changed else 'table-light unchanged-field' }}" style="{{ '' if changed else 'display: none;' }}">
        <td>{{ field.key }}</td>
        <td>{{ field.old }}</td>
        <td>{{ field.new }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Toggle Script -->
<script>
  const checkbox = document.getElementById("showAllFields");
  checkbox.addEventListener("change", function () {
    const rows = document.querySelectorAll(".unchanged-field");
    rows.forEach(row => {
      row.style.display = this.checked ? "" : "none";
    });
  });
</script>

{% endblock %}
