{% extends "base.html" %}

{% block header_css_and_js %}
  <!-- DataTables Core -->
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <!-- FixedHeader plugin -->
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css">
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
{% endblock %}

{% block content_1 %}

<style>
  thead.review-header th {
    vertical-align: middle;
    padding: 0.5rem;
    background-color: #245a9a;
    color: white;
    text-align: left;
  }

  th.confirm-th {
    width: 1%;
    text-align: center !important;
  }

  th.confirm-th .confirm-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  table.dataTable th,
  table.dataTable td {
    border-color: #dee2e6 !important;
  }

  thead.review-header .action-row th {
    background-color: #f8f9fa !important;
    color: #000;
    text-align: left;
    padding: 0.5rem 1rem;
  }
</style>

<div class="container-fluid post-nav-buffer mb-3">
  <h2 class="mb-4">üßæ Review Staged Upload</h2>

  <div class="mb-3">
    {% if is_new_row %}
      <strong class="text-primary">üÜï New Incidence ID:</strong> {{ id_incidence }}
    {% else %}
      <strong class="text-primary">üìÅ Existing Incidence ID:</strong> {{ id_incidence }}
    {% endif %}
  </div>

  <div class="alert alert-info small mb-3">
    <strong>Note:</strong> For fields that would overwrite existing data, you must check the <strong>Confirm</strong> box to approve the change.
    Unchecked fields will not be updated.
  </div>

  <form id="confirm-form" method="POST" action="{{ url_for('main.confirm_staged', id_=id_incidence) }}">
    <table id="reviewTable" class="table table-sm table-bordered table-hover review-table">
      <thead class="review-header">
        <tr class="action-row align-middle">
          <th colspan="4">
            <div class="d-flex justify-content-between flex-wrap align-items-center gap-3">
              <div class="d-flex align-items-center gap-3 flex-wrap">
                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" id="hideUnchangedFields">
                  <label class="form-check-label" for="hideUnchangedFields">Hide unchanged fields</label>
                </div>
                <div class="input-group input-group-sm" style="max-width: 300px;">
                  <span class="input-group-text">üîç</span>
                  <input type="text" class="form-control" id="fieldSearch" placeholder="Filter fields by name or value">
                </div>
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-outline-dark btn-sm" href="{{ url_for('main.upload_file') }}">Cancel</a>
                <button form="confirm-form" type="submit" class="btn btn-success btn-sm">‚úÖ Confirm Upload</button>
              </div>
            </div>
          </th>
        </tr>
        <tr>
          <th class="confirm-th">
            <div class="confirm-header">
              <span>Confirm</span>
              <input class="form-check-input" type="checkbox" id="selectAllConfirmations" title="Toggle all confirmations">
            </div>
          </th>
          <th>Key</th>
          <th>Old Value (DB)</th>
          <th>New Value (Upload)</th>
        </tr>
      </thead>
      <tbody>
        {% for field in staged_fields %}
          {% set changed = field.changed %}
          <tr class="field-row {% if not changed %}unchanged-field{% else %}table-warning{% endif %}">
            <td class="text-center">
              {% if field.requires_confirmation %}
                <input type="checkbox" name="confirm_overwrite_{{ field.key }}" class="confirm-checkbox">
              {% else %}
                ‚Äî
              {% endif %}
            </td>
            <td>{{ field.key }}</td>
            <td>{{ field.old }}</td>
            <td>
              {% if changed %}
                <mark>{{ field.new }}</mark>
              {% else %}
                {{ field.new }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</div>

<script>
  const selectAllBox = document.getElementById("selectAllConfirmations");

  function updateConfirmAllState() {
    const checkboxes = document.querySelectorAll(".confirm-checkbox");
    const checkedCount = [...checkboxes].filter(cb => cb.checked).length;

    if (checkedCount === 0) {
      selectAllBox.indeterminate = false;
      selectAllBox.checked = false;
    } else if (checkedCount === checkboxes.length) {
      selectAllBox.indeterminate = false;
      selectAllBox.checked = true;
    } else {
      selectAllBox.indeterminate = true;
      selectAllBox.checked = false;
    }
  }

  function updateVisibleRows() {
    const hideUnchanged = document.getElementById("hideUnchangedFields").checked;
    const query = document.getElementById("fieldSearch").value.toLowerCase();

    document.querySelectorAll("tbody tr").forEach(function (row) {
      const isUnchanged = row.classList.contains("unchanged-field");
      const matchesFilter = row.innerText.toLowerCase().includes(query);
      row.style.display = matchesFilter && (!hideUnchanged || !isUnchanged) ? "" : "none";
    });
  }

  document.getElementById("hideUnchangedFields").addEventListener("change", updateVisibleRows);
  document.getElementById("fieldSearch").addEventListener("input", updateVisibleRows);
  selectAllBox.addEventListener("change", function () {
    document.querySelectorAll(".confirm-checkbox").forEach(cb => cb.checked = this.checked);
    updateConfirmAllState();
  });
  document.querySelectorAll(".confirm-checkbox").forEach(cb => {
    cb.addEventListener("change", updateConfirmAllState);
  });

  window.addEventListener("DOMContentLoaded", () => {
    updateVisibleRows();
    updateConfirmAllState();

    $('#reviewTable').DataTable({
      fixedHeader: {
        header: true,
        headerOffset: $('.navbar').outerHeight() || 56
      },
      paging: false,
      info: false,
      ordering: true,
      stripeClasses: [],
      searching: false,
      columnDefs: [
        { orderable: false, targets: 0 }
      ]
    });
  });
</script>

{% endblock %}
