{% extends "base.html" %}

{% block content_1 %}

<div class="container my-4">
  <h2 class="mb-4">üßæ Review Staged Upload</h2>

  <div class="mb-3">
    <strong>Incidence ID:</strong> {{ id_incidence }}
  </div>

  {% if is_new_row %}
    <div class="alert alert-info">
      üìå <strong>This is a new incidence.</strong>
    </div>
  {% else %}
    <div class="alert alert-warning">
      ‚ö†Ô∏è <strong>This matches an existing incidence and may update it.</strong>
    </div>
  {% endif %}

  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="showAllFields" checked>
    <label class="form-check-label" for="showAllFields">Show all fields (including unchanged)</label>
  </div>

  <input type="text" class="form-control mb-3" id="fieldSearch" placeholder="üîç Filter fields by name or value">

  <form method="POST" action="{{ url_for('main.confirm_staged', id_=id_incidence) }}">
    <table class="table table-bordered table-hover">
      <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
        <tr>
          <th>Key</th>
          <th>Old Value (DB)</th>
          <th>New Value (Upload)</th>
          <th>
            Confirm Overwrite
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAllConfirmations">
              <label class="form-check-label small" for="selectAllConfirmations">Select All</label>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        {% for field in staged_fields %}
          {% set changed = field.changed %}
          <tr class="field-row {% if not changed %}unchanged-field{% else %}table-warning{% endif %}">
            <td>{{ field.key }}</td>
            <td>{{ field.old }}</td>
            <td>
              {% if changed %}
                <mark>{{ field.new }}</mark>
              {% else %}
                {{ field.new }}
              {% endif %}
            </td>
            <td class="text-center">
              {% if field.requires_confirmation %}
                <input type="checkbox" name="confirm_overwrite_{{ field.key }}" class="confirm-checkbox">
              {% else %}
                ‚Äî
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-end mt-4">
      <button type="submit" class="btn btn-success btn-lg">
        ‚úÖ Confirm and Save Upload
      </button>
    </div>
  </form>
</div>

<script>
  // Toggle visibility of unchanged rows
  document.getElementById("showAllFields").addEventListener("change", function () {
    const showAll = this.checked;
    document.querySelectorAll(".unchanged-field").forEach(function (row) {
      row.style.display = showAll ? "" : "none";
    });
  });

  // Select All Confirmations
  document.getElementById("selectAllConfirmations").addEventListener("change", function () {
    const allCheckboxes = document.querySelectorAll(".confirm-checkbox");
    allCheckboxes.forEach(cb => cb.checked = this.checked);
  });

  // Field Search Filtering
  document.getElementById("fieldSearch").addEventListener("input", function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll("tbody tr").forEach(function (row) {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(query) ? "" : "none";
    });
  });
</script>

{% endblock %}
