<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Review Staged Upload</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <style>
    thead.review-header {
      position: sticky;
      top: 70px;
      z-index: 9;
      background-color: #245a9a;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    thead.review-header th {
      text-align: center;
      vertical-align: middle;
      font-weight: 600;
      padding: 0.5rem;
      background-color: #245a9a;
      color: white;
    }
    th.confirm-th {
      width: 1%;
      text-align: center;
    }
    th.confirm-th .confirm-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }
    table.review-table td {
      vertical-align: middle;
    }
  </style>
</head>
<body class="container my-4">

<h2 class="mb-4">🧾 Review Staged Upload</h2>
<div class="alert alert-info small mb-3">
  <strong>Note:</strong> For fields that would overwrite existing data, check the <strong>Confirm</strong> box.
</div>
<div class="row g-2 mb-3 align-items-center">
  <div class="col-auto">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="hideUnchangedFields">
      <label class="form-check-label" for="hideUnchangedFields">Hide unchanged fields</label>
    </div>
  </div>
  <div class="col">
    <input type="text" class="form-control" id="fieldSearch" placeholder="🔍 Filter fields by name or value">
  </div>
</div>
<form method="POST" action="/confirm_staged/1002">
  <table id="reviewTable" class="table table-sm table-bordered table-hover review-table">
    <thead class="review-header">
      <tr>
        <th class="confirm-th">
          <div class="confirm-header">
            <span>Confirm</span>
            <input class="form-check-input" type="checkbox" id="selectAllConfirmations" title="Toggle all confirmations">
          </div>
        </th>
        <th>Key</th>
        <th>Old Value (DB)</th>
        <th>New Value (Upload)</th>
        <th style="display:none">Unchanged</th>
      </tr>
    </thead>
    <tbody>
      <!-- Example row; repeat as needed -->
      <tr class="field-row" data-unchanged="1">
        <td class="text-center">—</td>
        <td>field_name</td>
        <td>value_from_db</td>
        <td>value_from_upload</td>
        <td style="display:none">1</td>
      </tr>
    </tbody>
  </table>
  <div class="text-end mt-4">
    <button type="submit" class="btn btn-success btn-lg">
      ✅ Confirm and Save Upload
    </button>
  </div>
</form>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
  const selectAllBox = document.getElementById("selectAllConfirmations");
  function updateConfirmAllState() {
    const checkboxes = document.querySelectorAll(".confirm-checkbox");
    const checkedCount = [...checkboxes].filter(cb => cb.checked).length;
    selectAllBox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    selectAllBox.checked = checkedCount === checkboxes.length;
  }
  selectAllBox.addEventListener("change", function () {
    document.querySelectorAll(".confirm-checkbox").forEach(cb => cb.checked = this.checked);
    updateConfirmAllState();
  });
  document.querySelectorAll(".confirm-checkbox").forEach(cb => cb.addEventListener("change", updateConfirmAllState));

  let hideUnchanged = false;
  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
    if (!hideUnchanged) return true;
    return data[4] !== "1"; // hide if unchanged
  });

  $(document).ready(function() {
    const table = $('#reviewTable').DataTable({
      stripeClasses: [],
      paging: false,
      ordering: true,
      info: false,
      searching: true,
      rowCallback: function(row, data, index) {
        row.classList.remove("table-light", "table-secondary");
        row.classList.add(index % 2 === 0 ? "table-light" : "table-secondary");
      },
      columnDefs: [{ targets: [4], visible: false }]
    });

    $('#hideUnchangedFields').on('change', function() {
      hideUnchanged = this.checked;
      table.draw();
    });

    $('#fieldSearch').on('input', function() {
      table.search(this.value).draw();
    });
  });
</script>
</body>
</html>
