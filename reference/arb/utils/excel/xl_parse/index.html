<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://tony-held-carb.github.io/reference/arb/utils/excel/xl_parse/" />
      <link rel="shortcut icon" href="../../../../../img/favicon.ico" />
    <title>arb.utils.excel.xl_parse - CalSMP Operator Feedback Portal</title>
    <link rel="stylesheet" href="../../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "arb.utils.excel.xl_parse";
        var mkdocs_page_input_path = "reference\\arb\\utils\\excel\\xl_parse.md";
        var mkdocs_page_url = "/reference/arb/utils/excel/xl_parse/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../../.." class="icon icon-home"> CalSMP Operator Feedback Portal
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../../..">Welcome &amp; Instructions</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" >Arb</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../../../wsgi/">arb.wsgi</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Auth</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/default_settings/">arb.auth.default_settings</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/email_util/">arb.auth.email_util</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/forms/">arb.auth.forms</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/login_manager/">arb.auth.login_manager</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/migrate_roles/">arb.auth.migrate_roles</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/models/">arb.auth.models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/okta_settings/">arb.auth.okta_settings</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/role_decorators/">arb.auth.role_decorators</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/role_examples/">arb.auth.role_examples</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/routes/">arb.auth.routes</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth/test_auth/">arb.auth.test_auth</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Auth example app</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth_example_app/app/">arb.auth_example_app.app</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth_example_app/config/">arb.auth_example_app.config</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth_example_app/extensions/">arb.auth_example_app.extensions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../auth_example_app/wsgi/">arb.auth_example_app.wsgi</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Routes</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../auth_example_app/routes/admin/">arb.auth_example_app.routes.admin</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../auth_example_app/routes/main/">arb.auth_example_app.routes.main</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../auth_example_app/routes/user_management/">arb.auth_example_app.routes.user_management</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Logging</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../logging/arb_logging/">arb.logging.arb_logging</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Portal</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/app/">arb.portal.app</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/constants/">arb.portal.constants</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/db_hardcoded/">arb.portal.db_hardcoded</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/extensions/">arb.portal.extensions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/globals/">arb.portal.globals</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/json_update_util/">arb.portal.json_update_util</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/routes/">arb.portal.routes</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/sqla_models/">arb.portal.sqla_models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/wtf_landfill/">arb.portal.wtf_landfill</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/wtf_oil_and_gas/">arb.portal.wtf_oil_and_gas</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../portal/wtf_upload/">arb.portal.wtf_upload</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Config</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/config/accessors/">arb.portal.config.accessors</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/config/settings/">arb.portal.config.settings</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Startup</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/startup/db/">arb.portal.startup.db</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/startup/flask/">arb.portal.startup.flask</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/startup/runtime_info/">arb.portal.startup.runtime_info</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Utils</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/db_ingest_util/">arb.portal.utils.db_ingest_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/db_introspection_util/">arb.portal.utils.db_introspection_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/file_upload_util/">arb.portal.utils.file_upload_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/form_mapper/">arb.portal.utils.form_mapper</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/github_and_ai/">arb.portal.utils.github_and_ai</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/import_audit/">arb.portal.utils.import_audit</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/route_util/">arb.portal.utils.route_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/sector_util/">arb.portal.utils.sector_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../portal/utils/test_cleanup_util/">arb.portal.utils.test_cleanup_util</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" >Utils</a>
    <ul class="current">
                <li class="toctree-l3"><a class="reference internal" href="../../constants/">arb.utils.constants</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../database/">arb.utils.database</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../date_and_time/">arb.utils.date_and_time</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../diagnostics/">arb.utils.diagnostics</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../file_io/">arb.utils.file_io</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../io_wrappers/">arb.utils.io_wrappers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../json/">arb.utils.json</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../log_util/">arb.utils.log_util</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../misc/">arb.utils.misc</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../sql_alchemy/">arb.utils.sql_alchemy</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../web_html/">arb.utils.web_html</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../wtf_forms_util/">arb.utils.wtf_forms_util</a>
                </li>
                <li class="toctree-l3 current"><a class="reference internal current" >Excel</a>
    <ul class="current">
                <li class="toctree-l4"><a class="reference internal" href="../excel_compare/">arb.utils.excel.excel_compare</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../excel_compare_04/">arb.utils.excel.excel_compare_04</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../xl_create/">arb.utils.excel.xl_create</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../xl_file_structure/">arb.utils.excel.xl_file_structure</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../xl_hardcoded/">arb.utils.excel.xl_hardcoded</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../xl_misc/">arb.utils.excel.xl_misc</a>
                </li>
                <li class="toctree-l4 current"><a class="reference internal current" href="#">arb.utils.excel.xl_parse</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../..">CalSMP Operator Feedback Portal</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Reference</li>
          <li class="breadcrumb-item">Arb</li>
          <li class="breadcrumb-item">Utils</li>
          <li class="breadcrumb-item">Excel</li>
      <li class="breadcrumb-item active">arb.utils.excel.xl_parse</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="arbutilsexcelxl_parse"><code>arb.utils.excel.xl_parse</code></h1>


<div class="doc doc-object doc-module">



<a id="arb.utils.excel.xl_parse"></a>
    <div class="doc doc-contents first">

        <p>Module to parse and ingest Excel spreadsheet contents.</p>
<p>This module provides logic to convert Excel forms into structured dictionary representations,
including extraction of tab contents, metadata, and schema references. It is primarily used
to support automated feedback template parsing.</p>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li><code>schema_file_map</code> is a dict where keys are schema names and values are paths to JSON files.</li>
<li><code>schema_map</code> is a dict where keys are schema names and values are:
    {"schema": schema_dict, "metadata": metadata_dict}</li>
</ul>
</details>

<details class="example" open>
  <summary>Example</summary>
  <p>Input : xl_schema_map['oil_and_gas_v03']['schema']
Output: Dictionary representing the oil and gas schema</p>
</details>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.convert_upload_to_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_upload_to_json</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert an uploaded Excel or JSON file into a valid JSON payload file.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>file_path</code></b>
                  (<code><span title="pathlib.Path">Path</span></code>)
              –
              <div class="doc-md-description">
                <p>Path to the uploaded file.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="pathlib.Path">Path</span> | None</code>
              –
              <div class="doc-md-description">
                <p>Path | None:
- Path to JSON file (either original or newly created), or
- None if file type is unsupported or conversion fails.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="behavior" open>
  <summary>Behavior</summary>
  <ul>
<li>If the file has a <code>.json</code> extension:
    → Assume it is valid JSON and return as-is.</li>
<li>If the file has a <code>.xlsx</code> extension:
    → Attempt to parse using Excel schema logic.
    → Save converted contents as a <code>.json</code> file in the same directory.
    → Return the path to that JSON file.</li>
<li>If the file is neither <code>.xlsx</code> nor <code>.json</code>:
    → Log a warning and return None.</li>
</ul>
</details>

<details class="side-effects" open>
  <summary>Side Effects</summary>
  <ul>
<li>May write a <code>.json</code> file to disk if an Excel file is successfully parsed.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">convert_upload_to_json</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Convert an uploaded Excel or JSON file into a valid JSON payload file.</span>

<span class="sd">  Args:</span>
<span class="sd">    file_path (Path): Path to the uploaded file.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Path | None:</span>
<span class="sd">      - Path to JSON file (either original or newly created), or</span>
<span class="sd">      - None if file type is unsupported or conversion fails.</span>

<span class="sd">  Behavior:</span>
<span class="sd">    - If the file has a `.json` extension:</span>
<span class="sd">        → Assume it is valid JSON and return as-is.</span>
<span class="sd">    - If the file has a `.xlsx` extension:</span>
<span class="sd">        → Attempt to parse using Excel schema logic.</span>
<span class="sd">        → Save converted contents as a `.json` file in the same directory.</span>
<span class="sd">        → Return the path to that JSON file.</span>
<span class="sd">    - If the file is neither `.xlsx` nor `.json`:</span>
<span class="sd">        → Log a warning and return None.</span>

<span class="sd">  Side Effects:</span>
<span class="sd">    - May write a `.json` file to disk if an Excel file is successfully parsed.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">extension</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="n">json_path</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excel upload detected: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">xl_as_dict</span> <span class="o">=</span> <span class="n">parse_xl_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsed Excel to dict: </span><span class="si">{</span><span class="n">xl_as_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">json_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving Excel-derived JSON as: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">json_save_with_meta</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="n">xl_as_dict</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excel parsing failed for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">None</span>

  <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON upload detected: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">file_path</span>

  <span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file type: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">json_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.create_schema_file_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_schema_file_map</span><span class="p">(</span><span class="n">schema_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema_names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Create a dictionary mapping schema names to their JSON file paths.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>schema_path</code></b>
                  (<code><span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Folder containing schema files. Defaults to processed versions dir.</p>
              </div>
            </li>
            <li>
              <b><code>schema_names</code></b>
                  (<code><span title="list">list</span>[<span title="str">str</span>] | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Names of schemas to include. Defaults to schemas from TEMPLATES.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
              –
              <div class="doc-md-description">
                <p>dict[str, Path]: Map from schema name to a schema file path.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_schema_file_map</span><span class="p">(</span><span class="n">schema_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">schema_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Create a dictionary mapping schema names to their JSON file paths.</span>

<span class="sd">  Args:</span>
<span class="sd">    schema_path (str | Path | None): Folder containing schema files. Defaults to processed versions dir.</span>
<span class="sd">    schema_names (list[str] | None): Names of schemas to include. Defaults to schemas from TEMPLATES.</span>

<span class="sd">  Returns:</span>
<span class="sd">    dict[str, Path]: Map from schema name to a schema file path.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create_schema_file_map() called with </span><span class="si">{</span><span class="n">schema_path</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">schema_names</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">schema_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">schema_path</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">schema_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">schema_path</span> <span class="o">=</span> <span class="n">PROCESSED_VERSIONS</span> <span class="o">/</span> <span class="s2">&quot;xl_schemas&quot;</span>
  <span class="k">if</span> <span class="n">schema_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Import TEMPLATES from xl_create to ensure consistency</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">arb.utils.excel.xl_hardcoded</span><span class="w"> </span><span class="kn">import</span> <span class="n">EXCEL_TEMPLATES</span>
    <span class="n">schema_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;schema_version&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">EXCEL_TEMPLATES</span><span class="p">]</span>

  <span class="n">schema_file_map</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">for</span> <span class="n">schema_name</span> <span class="ow">in</span> <span class="n">schema_names</span><span class="p">:</span>
    <span class="n">schema_file_name</span> <span class="o">=</span> <span class="n">schema_name</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
    <span class="n">schema_file_path</span> <span class="o">=</span> <span class="n">schema_path</span> <span class="o">/</span> <span class="n">schema_file_name</span>
    <span class="n">schema_file_map</span><span class="p">[</span><span class="n">schema_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema_file_path</span>

  <span class="k">return</span> <span class="n">schema_file_map</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.ensure_schema" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ensure_schema</span><span class="p">(</span><span class="n">formatting_schema</span><span class="p">,</span> <span class="n">schema_map</span><span class="p">,</span> <span class="n">schema_alias</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Resolves a schema version using the schema map and alias mapping.
Logs a warning if an alias is used. Returns the resolved schema version, or None if not found.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>formatting_schema</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>The schema version to resolve.</p>
              </div>
            </li>
            <li>
              <b><code>schema_map</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>The mapping of valid schema versions.</p>
              </div>
            </li>
            <li>
              <b><code>schema_alias</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>The mapping of old schema names to new ones.</p>
              </div>
            </li>
            <li>
              <b><code>logger</code></b>
                  (<code><span title="logging.Logger">Logger</span></code>)
              –
              <div class="doc-md-description">
                <p>Logger for warnings/errors.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="str">str</span> | None</code>
              –
              <div class="doc-md-description">
                <p>str | None: The resolved schema version, or None if not found.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ensure_schema</span><span class="p">(</span><span class="n">formatting_schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">schema_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">schema_alias</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Resolves a schema version using the schema map and alias mapping.</span>
<span class="sd">  Logs a warning if an alias is used. Returns the resolved schema version, or None if not found.</span>

<span class="sd">  Args:</span>
<span class="sd">      formatting_schema (str): The schema version to resolve.</span>
<span class="sd">      schema_map (dict): The mapping of valid schema versions.</span>
<span class="sd">      schema_alias (dict): The mapping of old schema names to new ones.</span>
<span class="sd">      logger: Logger for warnings/errors.</span>

<span class="sd">  Returns:</span>
<span class="sd">      str | None: The resolved schema version, or None if not found.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">formatting_schema</span> <span class="ow">in</span> <span class="n">schema_map</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">formatting_schema</span>
  <span class="k">if</span> <span class="n">formatting_schema</span> <span class="ow">in</span> <span class="n">schema_alias</span><span class="p">:</span>
    <span class="n">new_schema_version</span> <span class="o">=</span> <span class="n">schema_alias</span><span class="p">[</span><span class="n">formatting_schema</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Schema &#39;</span><span class="si">{</span><span class="n">formatting_schema</span><span class="si">}</span><span class="s2">&#39; not found. Using alias &#39;</span><span class="si">{</span><span class="n">new_schema_version</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_schema_version</span> <span class="ow">in</span> <span class="n">schema_map</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">new_schema_version</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alias &#39;</span><span class="si">{</span><span class="n">new_schema_version</span><span class="si">}</span><span class="s2">&#39; not found in schema_map.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">None</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Schema &#39;</span><span class="si">{</span><span class="n">formatting_schema</span><span class="si">}</span><span class="s2">&#39; not found and no alias available.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.extract_tabs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_tabs</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="n">schema_map</span><span class="p">,</span> <span class="n">xl_as_dict</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Extract data from the data tabs that are enumerated in the schema tab.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>wb</code></b>
                  (<code><span title="Workbook">Workbook</span></code>)
              –
              <div class="doc-md-description">
                <p>OpenPyXL workbook object.</p>
              </div>
            </li>
            <li>
              <b><code>schema_map</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Schema map with schema definitions.</p>
              </div>
            </li>
            <li>
              <b><code>xl_as_dict</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>Parsed Excel content, including 'schemas' and 'metadata'.
                 Dictionary with schema tab where keys are the data tab names and values are the formatting_schema to
                 parse the tab.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span></code>
)              –
              <div class="doc-md-description">
                <p>Updated xl_as_dict including parsed 'tab_contents'.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_tabs</span><span class="p">(</span><span class="n">wb</span><span class="p">:</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span><span class="p">,</span>
                 <span class="n">schema_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
                 <span class="n">xl_as_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Extract data from the data tabs that are enumerated in the schema tab.</span>

<span class="sd">  Args:</span>
<span class="sd">    wb (Workbook): OpenPyXL workbook object.</span>
<span class="sd">    schema_map (dict[str, dict]): Schema map with schema definitions.</span>
<span class="sd">    xl_as_dict (dict): Parsed Excel content, including &#39;schemas&#39; and &#39;metadata&#39;.</span>
<span class="sd">                       Dictionary with schema tab where keys are the data tab names and values are the formatting_schema to</span>
<span class="sd">                       parse the tab.</span>

<span class="sd">  Returns:</span>
<span class="sd">    dict: Updated xl_as_dict including parsed &#39;tab_contents&#39;.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">skip_please_selects</span> <span class="o">=</span> <span class="kc">False</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xl_as_dict</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">formatting_schema</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;schemas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">resolved_schema</span> <span class="o">=</span> <span class="n">ensure_schema</span><span class="p">(</span><span class="n">formatting_schema</span><span class="p">,</span> <span class="n">schema_map</span><span class="p">,</span> <span class="n">schema_alias</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved_schema</span><span class="p">:</span>
      <span class="k">continue</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting data from &#39;</span><span class="si">{</span><span class="n">tab_name</span><span class="si">}</span><span class="s2">&#39;, using the formatting schema &#39;</span><span class="si">{</span><span class="n">formatting_schema</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tab_contents&#39;</span><span class="p">][</span><span class="n">tab_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="n">tab_name</span><span class="p">]</span>
    <span class="n">format_dict</span> <span class="o">=</span> <span class="n">schema_map</span><span class="p">[</span><span class="n">resolved_schema</span><span class="p">][</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">html_field_name</span><span class="p">,</span> <span class="n">lookup</span> <span class="ow">in</span> <span class="n">format_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">value_address</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;value_address&#39;</span><span class="p">]</span>
      <span class="n">value_type</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;value_type&#39;</span><span class="p">]</span>
      <span class="n">is_drop_down</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;is_drop_down&#39;</span><span class="p">]</span>
      <span class="c1"># works, but you get a lint error because this will break if value_address is not a single cell</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="n">value_address</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore[attr-defined]</span>
      <span class="c1"># Strip whitespace for string fields and log if changed</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value_type</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># todo - use sanitize_for_logging here?</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">sanitize_for_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">stripped_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">stripped_value</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Whitespace detected for field &#39;</span><span class="si">{</span><span class="n">html_field_name</span><span class="si">}</span><span class="s2">&#39; at </span><span class="si">{</span><span class="n">value_address</span><span class="si">}</span><span class="s2">: before strip: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">, after strip: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">stripped_value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">stripped_value</span>

      <span class="k">if</span> <span class="n">skip_please_selects</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_drop_down</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="n">PLEASE_SELECT</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">html_field_name</span><span class="si">}</span><span class="s2"> because it is a drop down and is set to </span><span class="si">{</span><span class="n">PLEASE_SELECT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="k">continue</span>

      <span class="c1"># Try to cast the spreadsheet data to the desired type if possible</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_type</span><span class="p">):</span>
          <span class="c1"># if it is not supposed to be of type string, but it is a zero-length string, turn it to None</span>
          <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &lt;</span><span class="si">{</span><span class="n">html_field_name</span><span class="si">}</span><span class="s2">&gt; value at &lt;</span><span class="si">{</span><span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;value_address&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&gt; is &lt;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&gt; &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;and is of type &lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt; whereas it should be of type &lt;</span><span class="si">{</span><span class="n">value_type</span><span class="si">}</span><span class="s2">&gt;.  &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Attempting to convert the value to the correct type&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="c1"># convert to datetime using a parser if possible</span>
              <span class="c1"># todo - datetime - seems like I could cast to utc here for persistence</span>
              <span class="k">if</span> <span class="n">value_type</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
                <span class="n">local_datetime</span> <span class="o">=</span> <span class="n">excel_str_to_naive_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">local_datetime</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_datetime_naive</span><span class="p">(</span><span class="n">local_datetime</span><span class="p">):</span>
                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date time </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not a naive datetime, skipping to avoid data corruption&quot;</span><span class="p">)</span>
                  <span class="k">continue</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">local_datetime</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use default repr-like conversion if not a datetime</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
              <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type conversion successful.  value is now &lt;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&gt; with type: &lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
              <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type conversion failed, resetting value to None&quot;</span><span class="p">)</span>
              <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tab_contents&#39;</span><span class="p">][</span><span class="n">tab_name</span><span class="p">][</span><span class="n">html_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

      <span class="k">if</span> <span class="s1">&#39;label_address&#39;</span> <span class="ow">in</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">lookup</span><span class="p">:</span>
        <span class="n">label_address</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;label_address&#39;</span><span class="p">]</span>
        <span class="c1"># works, but you get a lint error because this will break if value_address is not a single cell</span>
        <span class="n">label_xl</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="n">label_address</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="n">label_schema</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label_xl</span> <span class="o">!=</span> <span class="n">label_schema</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Schema data label and spreadsheet data label differ.&quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">schema label = </span><span class="si">{</span><span class="n">label_schema</span><span class="si">}</span><span class="se">\n\t</span><span class="s2">spreadsheet label (</span><span class="si">{</span><span class="n">label_address</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">label_xl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial spreadsheet extraction of &#39;</span><span class="si">{</span><span class="n">tab_name</span><span class="si">}</span><span class="s2">&#39; yields </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;tab_contents&#39;</span><span class="p">][</span><span class="n">tab_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Some cells should be spit into multiple dictionary entries (such as full name, lat/log)</span>
    <span class="n">split_compound_keys</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;tab_contents&#39;</span><span class="p">][</span><span class="n">tab_name</span><span class="p">])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final corrected spreadsheet extraction of &#39;</span><span class="si">{</span><span class="n">tab_name</span><span class="si">}</span><span class="s2">&#39; yields </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;tab_contents&#39;</span><span class="p">][</span><span class="n">tab_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.get_json_file_name_old" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_json_file_name_old</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Depreciated: use convert_upload_to_json instead</p>
<p>Convert a file name (Excel or JSON) into a JSON file name, parsing if needed.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>file_name</code></b>
                  (<code><span title="pathlib.Path">Path</span></code>)
              –
              <div class="doc-md-description">
                <p>The uploaded file.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="pathlib.Path">Path</span> | None</code>
              –
              <div class="doc-md-description">
                <p>Path | None: JSON file path if parsed or detected, otherwise None.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Notes:
- If the file_name is a JSON file (has .json extension), the file_name is the json_file_name.
- If the file is an Excel file (.xlsx extension), try to parse it into a JSON file and return the JSON file name
  of the parsed contents.
- If the file is neither a json file nr a spreadsheet that can be parsed into a json file, return None.
- If the file was already a json file, return the file name unaltered.
- If the file was an Excel file, return the json file that its data was extracted to.
- For all other file types return None.</p>


            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_json_file_name_old</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Depreciated: use convert_upload_to_json instead</span>

<span class="sd">  Convert a file name (Excel or JSON) into a JSON file name, parsing if needed.</span>

<span class="sd">  Args:</span>
<span class="sd">    file_name (Path): The uploaded file.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Path | None: JSON file path if parsed or detected, otherwise None.</span>

<span class="sd">  Notes:</span>
<span class="sd">  - If the file_name is a JSON file (has .json extension), the file_name is the json_file_name.</span>
<span class="sd">  - If the file is an Excel file (.xlsx extension), try to parse it into a JSON file and return the JSON file name</span>
<span class="sd">    of the parsed contents.</span>
<span class="sd">  - If the file is neither a json file nr a spreadsheet that can be parsed into a json file, return None.</span>
<span class="sd">  - If the file was already a json file, return the file name unaltered.</span>
<span class="sd">  - If the file was an Excel file, return the json file that its data was extracted to.</span>
<span class="sd">  - For all other file types return None.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">json_file_name</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="n">extension</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">suffix</span>
  <span class="c1"># logger.debug(f&quot;{extension=}&quot;)</span>
  <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excel file upload detected.  File name: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># xl_as_dict = xl_path_to_dict(file_name)</span>
    <span class="n">xl_as_dict</span> <span class="o">=</span> <span class="n">parse_xl_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xl_as_dict</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">json_file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving extracted data from Excel as: </span><span class="si">{</span><span class="n">json_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">json_save_with_meta</span><span class="p">(</span><span class="n">json_file_name</span><span class="p">,</span> <span class="n">xl_as_dict</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Json file upload detected.  File name: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">json_file_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown file type upload detected.  File name: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">json_file_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.get_spreadsheet_key_value_pairs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_spreadsheet_key_value_pairs</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">top_left_cell</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Read key-value pairs from a worksheet starting at a given cell.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>wb</code></b>
                  (<code><span title="Workbook">Workbook</span></code>)
              –
              <div class="doc-md-description">
                <p>OpenPyXL workbook object.</p>
              </div>
            </li>
            <li>
              <b><code>tab_name</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>Name of the worksheet tab.</p>
              </div>
            </li>
            <li>
              <b><code>top_left_cell</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>Top-left cell of the key/value pair region.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span> | None]</code>
              –
              <div class="doc-md-description">
                <p>dict[str, str | None]: Parsed key-value pairs.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_spreadsheet_key_value_pairs</span><span class="p">(</span><span class="n">wb</span><span class="p">:</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span><span class="p">,</span>
                                    <span class="n">tab_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                    <span class="n">top_left_cell</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Read key-value pairs from a worksheet starting at a given cell.</span>

<span class="sd">  Args:</span>
<span class="sd">    wb (Workbook): OpenPyXL workbook object.</span>
<span class="sd">    tab_name (str): Name of the worksheet tab.</span>
<span class="sd">    top_left_cell (str): Top-left cell of the key/value pair region.</span>

<span class="sd">  Returns:</span>
<span class="sd">    dict[str, str | None]: Parsed key-value pairs.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># logger.debug(f&quot;{type(wb)=}, &quot;)</span>
  <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="n">tab_name</span><span class="p">]</span>

  <span class="c1"># logger.debug(f&quot;{type(ws)=}, &quot;)</span>

  <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">row_offset</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="n">top_left_cell</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row_offset</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="n">top_left_cell</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row_offset</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
      <span class="n">return_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
      <span class="n">row_offset</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">break</span>

  <span class="k">return</span> <span class="n">return_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.initialize_module" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize_module</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initialize the module by calling set_globals().</p>
<p>This function loads default schema mappings into global variables.</p>


            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_module</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Initialize the module by calling set_globals().</span>

<span class="sd">  This function loads default schema mappings into global variables.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;initialize_module() called&quot;</span><span class="p">)</span>
  <span class="n">set_globals</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.load_schema_file_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_schema_file_map</span><span class="p">(</span><span class="n">schema_file_map</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Load JSON schema and metadata from a mapping of schema name to a file path.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>schema_file_map</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Keys are schema names, values are JSON schema file paths.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>]</code>
              –
              <div class="doc-md-description">
                <p>dict[str, dict]: Dictionary where keys are schema names and values are dicts with:
- "schema": The schema dictionary.
- "metadata": Metadata extracted from the JSON.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_schema_file_map</span><span class="p">(</span><span class="n">schema_file_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Load JSON schema and metadata from a mapping of schema name to a file path.</span>

<span class="sd">  Args:</span>
<span class="sd">    schema_file_map (dict[str, Path]): Keys are schema names, values are JSON schema file paths.</span>

<span class="sd">  Returns:</span>
<span class="sd">    dict[str, dict]: Dictionary where keys are schema names and values are dicts with:</span>
<span class="sd">      - &quot;schema&quot;: The schema dictionary.</span>
<span class="sd">      - &quot;metadata&quot;: Metadata extracted from the JSON.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_schema_file_map() called with </span><span class="si">{</span><span class="n">schema_file_map</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">schema_map</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">for</span> <span class="n">schema_name</span><span class="p">,</span> <span class="n">json_path</span> <span class="ow">in</span> <span class="n">schema_file_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">schema</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">json_load_with_meta</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
    <span class="n">schema_map</span><span class="p">[</span><span class="n">schema_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">}</span>

  <span class="k">return</span> <span class="n">schema_map</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.load_xl_schema" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_xl_schema</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Load schema and metadata from a JSON file.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>file_name</code></b>
                  (<code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>)
              –
              <div class="doc-md-description">
                <p>Path to a JSON schema file.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="tuple">tuple</span>[<span title="dict">dict</span>, <span title="dict">dict</span>]</code>
              –
              <div class="doc-md-description">
                <p>tuple[dict, dict]: Tuple of (schema dict, metadata dict).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_xl_schema</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Load schema and metadata from a JSON file.</span>

<span class="sd">  Args:</span>
<span class="sd">    file_name (str | Path): Path to a JSON schema file.</span>

<span class="sd">  Returns:</span>
<span class="sd">    tuple[dict, dict]: Tuple of (schema dict, metadata dict).</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_xl_schema() called with </span><span class="si">{</span><span class="n">file_name</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">schema</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">json_load_with_meta</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">schema</span><span class="p">,</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Run all schema and Excel file parsing test functions for diagnostic purposes.</p>


            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Run all schema and Excel file parsing test functions for diagnostic purposes.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">test_load_xl_schemas</span><span class="p">()</span>
  <span class="n">test_load_schema_file_map</span><span class="p">()</span>
  <span class="n">test_parse_xl_file</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.parse_xl_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_xl_file</span><span class="p">(</span><span class="n">xl_path</span><span class="p">,</span> <span class="n">schema_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Parse a spreadsheet and return a dictionary representation using the given schema.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>xl_path</code></b>
                  (<code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>)
              –
              <div class="doc-md-description">
                <p>Path to the Excel spreadsheet.</p>
              </div>
            </li>
            <li>
              <b><code>schema_map</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>] | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Map of schema names to their definitions.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>]</code>
)              –
              <div class="doc-md-description">
                <p>Dictionary with extracted metadata, schemas, and tab contents.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Notes:
- tutorial on openpyxl: https://openpyxl.readthedocs.io/en/stable/tutorial.html</p>


            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_xl_file</span><span class="p">(</span><span class="n">xl_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
                  <span class="n">schema_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Parse a spreadsheet and return a dictionary representation using the given schema.</span>

<span class="sd">  Args:</span>
<span class="sd">    xl_path (str | Path): Path to the Excel spreadsheet.</span>
<span class="sd">    schema_map (dict[str, dict] | None): Map of schema names to their definitions.</span>

<span class="sd">  Returns:</span>
<span class="sd">    dict: Dictionary with extracted metadata, schemas, and tab contents.</span>

<span class="sd">  Notes:</span>
<span class="sd">  - tutorial on openpyxl: https://openpyxl.readthedocs.io/en/stable/tutorial.html</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parse_xl_with_schema_dict() called with </span><span class="si">{</span><span class="n">xl_path</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">schema_map</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">schema_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">schema_map</span> <span class="o">=</span> <span class="n">xl_schema_map</span>

  <span class="c1"># Dictionary data structure to store Excel contents</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">result</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">result</span><span class="p">[</span><span class="s1">&#39;schemas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tab_contents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="c1"># Notes on data_only argument.  By default, .value returns the &#39;formula&#39; in the cell.</span>
  <span class="c1"># If data_only=True, then .value returns the last &#39;value&#39; that was evaluated at the cell.</span>
  <span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="n">xl_path</span><span class="p">,</span> <span class="n">keep_vba</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="c1"># Extract metadata and schema information from hidden tabs</span>
  <span class="k">if</span> <span class="n">EXCEL_METADATA_TAB_NAME</span> <span class="ow">in</span> <span class="n">wb</span><span class="o">.</span><span class="n">sheetnames</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metadata tab detected in Excel file&quot;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_spreadsheet_key_value_pairs</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span>
                                                         <span class="n">EXCEL_METADATA_TAB_NAME</span><span class="p">,</span>
                                                         <span class="n">EXCEL_TOP_LEFT_KEY_VALUE_CELL</span>
                                                         <span class="p">)</span>
    <span class="c1"># todo - maybe want to alias the Sector here?  Refinery -&gt; Energy</span>
  <span class="k">if</span> <span class="n">EXCEL_SCHEMA_TAB_NAME</span> <span class="ow">in</span> <span class="n">wb</span><span class="o">.</span><span class="n">sheetnames</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Schema tab detected in Excel file&quot;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;schemas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_spreadsheet_key_value_pairs</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span>
                                                        <span class="n">EXCEL_SCHEMA_TAB_NAME</span><span class="p">,</span>
                                                        <span class="n">EXCEL_TOP_LEFT_KEY_VALUE_CELL</span><span class="p">)</span>
    <span class="c1"># todo - maybe want to alias schemas here before extract tabs</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spreadsheet must have a </span><span class="si">{</span><span class="n">EXCEL_SCHEMA_TAB_NAME</span><span class="si">}</span><span class="s1"> tab&#39;</span><span class="p">)</span>

  <span class="c1"># extract data tabs content using specified schemas</span>
  <span class="n">new_result</span> <span class="o">=</span> <span class="n">extract_tabs</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="n">schema_map</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">new_result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.set_globals" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_globals</span><span class="p">(</span><span class="n">xl_schema_file_map_</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Set module-level global variables for schema file map and loaded schema map.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>xl_schema_file_map_</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>] | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Optional override for the schema file map.
If not provided, use a default list of pre-defined schema files based on TEMPLATES.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Calls <code>load_schema_file_map()</code> to populate xl_schema_map from JSON files.</li>
<li>Uses TEMPLATES structure from xl_create.py for consistency.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_globals</span><span class="p">(</span><span class="n">xl_schema_file_map_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Set module-level global variables for schema file map and loaded schema map.</span>

<span class="sd">  Args:</span>
<span class="sd">    xl_schema_file_map_ (dict[str, Path] | None): Optional override for the schema file map.</span>
<span class="sd">      If not provided, use a default list of pre-defined schema files based on TEMPLATES.</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Calls `load_schema_file_map()` to populate xl_schema_map from JSON files.</span>
<span class="sd">    - Uses TEMPLATES structure from xl_create.py for consistency.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">global</span> <span class="n">xl_schema_file_map</span><span class="p">,</span> <span class="n">xl_schema_map</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_globals() called with </span><span class="si">{</span><span class="n">xl_schema_file_map_</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">xl_schema_file_map_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Import TEMPLATES from xl_create to ensure consistency</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">arb.utils.excel.xl_hardcoded</span><span class="w"> </span><span class="kn">import</span> <span class="n">EXCEL_TEMPLATES</span>

    <span class="n">xl_schema_file_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">EXCEL_TEMPLATES</span><span class="p">:</span>
      <span class="n">schema_version</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;schema_version&quot;</span><span class="p">]</span>
      <span class="n">schema_path</span> <span class="o">=</span> <span class="n">PROCESSED_VERSIONS</span> <span class="o">/</span> <span class="s2">&quot;xl_schemas&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">.json&quot;</span>
      <span class="n">xl_schema_file_map</span><span class="p">[</span><span class="n">schema_version</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema_path</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">xl_schema_file_map</span> <span class="o">=</span> <span class="n">xl_schema_file_map_</span>

  <span class="c1"># load all the schemas</span>
  <span class="k">if</span> <span class="n">xl_schema_file_map</span><span class="p">:</span>
    <span class="n">xl_schema_map</span> <span class="o">=</span> <span class="n">load_schema_file_map</span><span class="p">(</span><span class="n">xl_schema_file_map</span><span class="p">)</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;globals are now: </span><span class="si">{</span><span class="n">xl_schema_file_map</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">xl_schema_map</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.split_compound_keys" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split_compound_keys</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Decompose compound keys into atomic fields.</p>
<p>Remove key/value pairs of entries that potentially contain compound keys and replace them with key value pairs
that are more atomic.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>dict_</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>Dictionary with potentially compound fields (e.g., lat_and_long).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If 'lat_and_long' is improperly formatted.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split_compound_keys</span><span class="p">(</span><span class="n">dict_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Decompose compound keys into atomic fields.</span>

<span class="sd">  Remove key/value pairs of entries that potentially contain compound keys and replace them with key value pairs</span>
<span class="sd">  that are more atomic.</span>

<span class="sd">  Args:</span>
<span class="sd">    dict_ (dict): Dictionary with potentially compound fields (e.g., lat_and_long).</span>

<span class="sd">  Raises:</span>
<span class="sd">    ValueError: If &#39;lat_and_long&#39; is improperly formatted.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">html_field_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">dict_</span><span class="p">[</span><span class="n">html_field_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">html_field_name</span> <span class="o">==</span> <span class="s1">&#39;lat_and_long&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">lat_longs</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_longs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;lat_arb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_longs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;long_arb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_longs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lat long must be a blank or a comma separated list of lat/long pairs&quot;</span><span class="p">)</span>
      <span class="k">del</span> <span class="n">dict_</span><span class="p">[</span><span class="n">html_field_name</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.test_load_schema_file_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_load_schema_file_map</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Debug test for loading a schema file map and displaying contents.</p>


            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_load_schema_file_map</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Debug test for loading a schema file map and displaying contents.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test_load_schema_file_map() called&quot;</span><span class="p">)</span>
  <span class="n">schema_map</span> <span class="o">=</span> <span class="n">create_schema_file_map</span><span class="p">()</span>
  <span class="n">schemas</span> <span class="o">=</span> <span class="n">load_schema_file_map</span><span class="p">(</span><span class="n">schema_map</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">schemas</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.test_load_xl_schemas" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_load_xl_schemas</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Debug test for loading default schemas from xl_schema_file_map.</p>


            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_load_xl_schemas</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Debug test for loading default schemas from xl_schema_file_map.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span><span class="w"> </span><span class="nn">arb.logging.arb_logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_pretty_printer</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">pp_log</span> <span class="o">=</span> <span class="n">get_pretty_printer</span><span class="p">()</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing load_xl_schemas() with test_load_xl_schemas&quot;</span><span class="p">)</span>
  <span class="n">schemas</span> <span class="o">=</span> <span class="n">load_schema_file_map</span><span class="p">(</span><span class="n">xl_schema_file_map</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing load_xl_schemas() with test_load_xl_schemas&quot;</span><span class="p">)</span>
  <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;schemas = </span><span class="si">{</span><span class="n">pp_log</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.utils.excel.xl_parse.test_parse_xl_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_parse_xl_file</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Debug test to parse a known Excel file into dictionary form using schemas.</p>


            <details class="quote">
              <summary>Source code in <code>arb\utils\excel\xl_parse.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_parse_xl_file</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Debug test to parse a known Excel file into dictionary form using schemas.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test_parse_xl_file() called&quot;</span><span class="p">)</span>
  <span class="n">xl_path</span> <span class="o">=</span> <span class="n">PROCESSED_VERSIONS</span> <span class="o">/</span> <span class="s2">&quot;xl_workbooks&quot;</span> <span class="o">/</span> <span class="s2">&quot;landfill_operator_feedback_v070_populated_01.xlsx&quot;</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xl_path</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">parse_xl_file</span><span class="p">(</span><span class="n">xl_path</span><span class="p">,</span> <span class="n">xl_schema_map</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../xl_misc/" class="btn btn-neutral float-left" title="arb.utils.excel.xl_misc"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../xl_misc/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../../..";</script>
    <script src="../../../../../js/theme_extra.js"></script>
    <script src="../../../../../js/theme.js"></script>
      <script src="../../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
