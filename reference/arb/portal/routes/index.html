<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://tony-held-carb.github.io/reference/arb/portal/routes/" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>arb.portal.routes - CalSMP Operator Feedback Portal</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "arb.portal.routes";
        var mkdocs_page_input_path = "reference\\arb\\portal\\routes.md";
        var mkdocs_page_url = "/reference/arb/portal/routes/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> CalSMP Operator Feedback Portal
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../..">Welcome &amp; Instructions</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" >Arb</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../../wsgi/">arb.wsgi</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Auth</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/default_settings/">arb.auth.default_settings</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/email_util/">arb.auth.email_util</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/forms/">arb.auth.forms</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/login_manager/">arb.auth.login_manager</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/migrate_roles/">arb.auth.migrate_roles</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/models/">arb.auth.models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/okta_settings/">arb.auth.okta_settings</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/role_decorators/">arb.auth.role_decorators</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/role_examples/">arb.auth.role_examples</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/routes/">arb.auth.routes</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth/test_auth/">arb.auth.test_auth</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Auth example app</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../auth_example_app/app/">arb.auth_example_app.app</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth_example_app/config/">arb.auth_example_app.config</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth_example_app/extensions/">arb.auth_example_app.extensions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../auth_example_app/wsgi/">arb.auth_example_app.wsgi</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Routes</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../auth_example_app/routes/admin/">arb.auth_example_app.routes.admin</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../auth_example_app/routes/main/">arb.auth_example_app.routes.main</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../auth_example_app/routes/user_management/">arb.auth_example_app.routes.user_management</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Logging</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../logging/arb_logging/">arb.logging.arb_logging</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" >Portal</a>
    <ul class="current">
                <li class="toctree-l3"><a class="reference internal" href="../app/">arb.portal.app</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../constants/">arb.portal.constants</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../db_hardcoded/">arb.portal.db_hardcoded</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../extensions/">arb.portal.extensions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../globals/">arb.portal.globals</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../json_update_util/">arb.portal.json_update_util</a>
                </li>
                <li class="toctree-l3 current"><a class="reference internal current" href="#">arb.portal.routes</a>
    <ul class="current">
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes">routes</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.apply_staged_update">apply_staged_update</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.confirm_staged">confirm_staged</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.delete_testing_range">delete_testing_range</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.diagnostics">diagnostics</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.discard_staged_update">discard_staged_update</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.export_portal_updates">export_portal_updates</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.incidence_delete">incidence_delete</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.incidence_update">incidence_update</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.index">index</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.java_script_diagnostic_test">java_script_diagnostic_test</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.js_diagnostic_log">js_diagnostic_log</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.landfill_incidence_create">landfill_incidence_create</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.list_staged">list_staged</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.list_uploads">list_uploads</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.og_incidence_create">og_incidence_create</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.review_staged">review_staged</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.search">search</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.serve_file">serve_file</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.show_database_structure">show_database_structure</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.show_dropdown_dict">show_dropdown_dict</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.show_feedback_form_structure">show_feedback_form_structure</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.show_log_file">show_log_file</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.upload_file">upload_file</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.upload_file_staged">upload_file_staged</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arb.portal.routes.view_portal_updates">view_portal_updates</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../sqla_models/">arb.portal.sqla_models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../wtf_landfill/">arb.portal.wtf_landfill</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../wtf_oil_and_gas/">arb.portal.wtf_oil_and_gas</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../wtf_upload/">arb.portal.wtf_upload</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Config</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../config/accessors/">arb.portal.config.accessors</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../config/settings/">arb.portal.config.settings</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Startup</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../startup/db/">arb.portal.startup.db</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../startup/flask/">arb.portal.startup.flask</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../startup/runtime_info/">arb.portal.startup.runtime_info</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Utils</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../utils/db_ingest_util/">arb.portal.utils.db_ingest_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../utils/db_introspection_util/">arb.portal.utils.db_introspection_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../utils/file_upload_util/">arb.portal.utils.file_upload_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../utils/form_mapper/">arb.portal.utils.form_mapper</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../utils/github_and_ai/">arb.portal.utils.github_and_ai</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../utils/import_audit/">arb.portal.utils.import_audit</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../utils/route_util/">arb.portal.utils.route_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../utils/sector_util/">arb.portal.utils.sector_util</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../utils/test_cleanup_util/">arb.portal.utils.test_cleanup_util</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Utils</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/constants/">arb.utils.constants</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/database/">arb.utils.database</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/date_and_time/">arb.utils.date_and_time</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/diagnostics/">arb.utils.diagnostics</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/file_io/">arb.utils.file_io</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/io_wrappers/">arb.utils.io_wrappers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/json/">arb.utils.json</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/log_util/">arb.utils.log_util</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/misc/">arb.utils.misc</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/sql_alchemy/">arb.utils.sql_alchemy</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/web_html/">arb.utils.web_html</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/wtf_forms_util/">arb.utils.wtf_forms_util</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Excel</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../utils/excel/excel_compare/">arb.utils.excel.excel_compare</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../utils/excel/excel_compare_04/">arb.utils.excel.excel_compare_04</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../utils/excel/xl_create/">arb.utils.excel.xl_create</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../utils/excel/xl_file_structure/">arb.utils.excel.xl_file_structure</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../utils/excel/xl_hardcoded/">arb.utils.excel.xl_hardcoded</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../utils/excel/xl_misc/">arb.utils.excel.xl_misc</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../utils/excel/xl_parse/">arb.utils.excel.xl_parse</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">CalSMP Operator Feedback Portal</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Reference</li>
          <li class="breadcrumb-item">Arb</li>
          <li class="breadcrumb-item">Portal</li>
      <li class="breadcrumb-item active">arb.portal.routes</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="arbportalroutes"><code>arb.portal.routes</code></h1>


<div class="doc doc-object doc-module">



<a id="arb.portal.routes"></a>
    <div class="doc doc-contents first">

        <p>Blueprint-based route definitions for the ARB Feedback Portal.</p>
<p>This module defines all Flask routes originally found in <code>app.py</code>,
now organized under the <code>main</code> Blueprint for modularity.</p>


<details class="module_attributes" open>
  <summary>Module_Attributes</summary>
  <p>main (Blueprint): Flask Blueprint for all portal routes.
logger (logging.Logger): Logger instance for this module.</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <p>from arb.portal.routes import main
app.register_blueprint(main)</p>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>All routes assume that <code>create_app()</code> registers the <code>main</code> Blueprint.</li>
<li>Developer diagnostics are inlined near the end of the module.</li>
</ul>
</details>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.apply_staged_update" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_staged_update</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply a staged update to the database for a specific incidence ID.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id_</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
                <p>Incidence ID to apply the staged update to.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>Response</code></b>(                  <code><span title="flask.Response">Response</span></code>
)              –
              <div class="doc-md-description">
                <p>Redirect to the incidence update page after applying the update.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.apply_staged_update--in-browser-post-apply_staged_update123">In browser: POST /apply_staged_update/123</h3>
<h3 id="arb.portal.routes.apply_staged_update--redirects-to-incidence_update123">Redirects to: /incidence_update/123/</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/apply_staged_update/&lt;int:id_&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_staged_update</span><span class="p">(</span><span class="n">id_</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Apply a staged update to the database for a specific incidence ID.</span>

<span class="sd">  Args:</span>
<span class="sd">    id_ (int): Incidence ID to apply the staged update to.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Response: Redirect to the incidence update page after applying the update.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: POST /apply_staged_update/123</span>
<span class="sd">    # Redirects to: /incidence_update/123/</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: apply_staged_update with id_: </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="c1"># staging_dir = Path(current_app.config[&quot;UPLOAD_STAGING_FOLDER&quot;])</span>
    <span class="n">staging_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">get_upload_folder</span><span class="p">())</span> <span class="o">/</span> <span class="s2">&quot;staging&quot;</span>

    <span class="n">staged_file</span> <span class="o">=</span> <span class="n">staging_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.json&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">staged_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Staged file does not exist: </span><span class="si">{</span><span class="n">staged_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Staged file not found.&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.upload_file_staged&quot;</span><span class="p">))</span>

    <span class="n">xl_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">json_load_with_meta</span><span class="p">(</span><span class="n">staged_file</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="n">final_id</span><span class="p">,</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">xl_dict_to_database</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">xl_dict</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied staged update for id=</span><span class="si">{</span><span class="n">final_id</span><span class="si">}</span><span class="s2">, sector=</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">staged_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted staged file: </span><span class="si">{</span><span class="n">staged_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">delete_error</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not delete staged file: </span><span class="si">{</span><span class="n">delete_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.incidence_update&quot;</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">final_id</span><span class="p">))</span>

  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to apply staged update.&quot;</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Error applying update. Please try again.&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.upload_file_staged&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.confirm_staged" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">confirm_staged</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Confirm and apply a staged update for a specific incidence ID and file.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id_</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
                <p>Incidence ID to update.</p>
              </div>
            </li>
            <li>
              <b><code>filename</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>Name of the staged file to confirm.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>Response</code></b>(                  <code><span title="flask.typing.ResponseReturnValue">ResponseReturnValue</span></code>
)              –
              <div class="doc-md-description">
                <p>Redirect to the incidence update page after applying the update.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.confirm_staged--in-browser-post-confirm_staged123myfilexlsx">In browser: POST /confirm_staged/123/myfile.xlsx</h3>
<h3 id="arb.portal.routes.confirm_staged--redirects-to-incidence_update123">Redirects to: /incidence_update/123/</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/confirm_staged/&lt;int:id_&gt;/&lt;filename&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">confirm_staged</span><span class="p">(</span><span class="n">id_</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResponseReturnValue</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Confirm and apply a staged update for a specific incidence ID and file.</span>

<span class="sd">  Args:</span>
<span class="sd">    id_ (int): Incidence ID to update.</span>
<span class="sd">    filename (str): Name of the staged file to confirm.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Response: Redirect to the incidence update page after applying the update.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: POST /confirm_staged/123/myfile.xlsx</span>
<span class="sd">    # Redirects to: /incidence_update/123/</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: confirm_staged with id_: </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2"> and filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="c1"># Resolve paths</span>
  <span class="n">root</span> <span class="o">=</span> <span class="n">get_upload_folder</span><span class="p">()</span>
  <span class="n">staged_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;staging&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
  <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">processed_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

  <span class="c1"># Load staged payload and metadata</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">staged_data</span><span class="p">,</span> <span class="n">staged_meta</span> <span class="o">=</span> <span class="n">json_load_with_meta</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">staged_path</span><span class="p">))</span>
    <span class="n">base_misc_json</span> <span class="o">=</span> <span class="n">staged_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_misc_json&quot;</span><span class="p">,</span> <span class="p">{})</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load staged file for ID </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.upload_file_staged&quot;</span><span class="p">))</span>

  <span class="c1"># Extract form data from the staged JSON structure</span>
  <span class="c1"># staged_data contains: {&#39;metadata&#39;: {...}, &#39;schemas&#39;: {...}, &#39;tab_contents&#39;: {&#39;Feedback Form&#39;: {...}}}</span>
  <span class="c1"># We need to extract just the form data from tab_contents and include sector from metadata</span>
  <span class="n">form_data</span> <span class="o">=</span> <span class="n">extract_tab_and_sector</span><span class="p">(</span><span class="n">staged_data</span><span class="p">,</span> <span class="n">tab_name</span><span class="o">=</span><span class="s2">&quot;Feedback Form&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">form_data</span><span class="p">:</span>
    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract form data from staged file for ID </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.upload_file_staged&quot;</span><span class="p">))</span>

  <span class="c1"># Get the database model</span>
  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;incidences&#39;</span>
  <span class="n">table</span> <span class="o">=</span> <span class="n">get_class_from_table_name</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

  <span class="c1"># Get or create the model row</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Getting/creating model row for id_incidence=</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">model_row</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">is_new_row</span> <span class="o">=</span> <span class="n">get_ensured_row</span><span class="p">(</span>
    <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
    <span class="n">primary_key_name</span><span class="o">=</span><span class="s2">&quot;id_incidence&quot;</span><span class="p">,</span>
    <span class="n">id_</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span>
    <span class="n">add_to_session</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Model row result: type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model_row</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;id_incidence=</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model_row</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id_incidence&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;is_new_row=</span><span class="si">{</span><span class="n">is_new_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="c1"># Check for concurrent DB changes</span>
  <span class="n">current_misc_json</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_row</span><span class="p">,</span> <span class="s2">&quot;misc_json&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Current misc_json: </span><span class="si">{</span><span class="n">current_misc_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Base misc_json from staging: </span><span class="si">{</span><span class="n">base_misc_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">current_misc_json</span> <span class="o">!=</span> <span class="n">base_misc_json</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Concurrent DB changes detected! &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;current_misc_json != base_misc_json&quot;</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">(</span>
      <span class="s2">&quot;⚠️ The database was changed by another user before your updates were confirmed. Please review the new database state and reconfirm which fields you wish to update.&quot;</span><span class="p">,</span>
      <span class="s2">&quot;warning&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.review_staged&quot;</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>

  <span class="c1"># Build update patch only for fields user confirmed</span>
  <span class="n">patch</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Building patch from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">form_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> form fields&quot;</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">form_data</span><span class="p">:</span>
    <span class="n">checkbox_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;confirm_overwrite_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">confirmed</span> <span class="o">=</span> <span class="n">checkbox_name</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>

    <span class="n">new_val</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="c1"># Ensure we have a dictionary to work with, even if misc_json is None</span>
    <span class="n">misc_json</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_row</span><span class="p">,</span> <span class="s2">&quot;misc_json&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">old_val</span> <span class="o">=</span> <span class="n">misc_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">confirmed</span><span class="p">:</span>
      <span class="n">patch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Added to patch: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s2"> (confirmed=</span><span class="si">{</span><span class="n">confirmed</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Final patch contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span><span class="si">}</span><span class="s2"> fields: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">patch</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] No fields in patch - no changes to save&quot;</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;No fields were confirmed for update. No changes saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.upload_file_staged&quot;</span><span class="p">))</span>

  <span class="c1"># 🆕 Prepare patch for JSON serialization (type coercion, datetime conversion, etc.)</span>
  <span class="n">patch</span> <span class="o">=</span> <span class="n">prep_payload_for_json</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Prepared patch for JSON: </span><span class="si">{</span><span class="n">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="c1"># Apply patch to the database model</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] About to call apply_json_patch_and_log with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span><span class="si">}</span><span class="s2"> fields&quot;</span><span class="p">)</span>
    <span class="n">apply_json_patch_and_log</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">model_row</span><span class="p">,</span>
      <span class="n">updates</span><span class="o">=</span><span class="n">patch</span><span class="p">,</span>
      <span class="n">json_field</span><span class="o">=</span><span class="s2">&quot;misc_json&quot;</span><span class="p">,</span>
      <span class="n">user</span><span class="o">=</span><span class="s2">&quot;anonymous&quot;</span><span class="p">,</span>
      <span class="n">comments</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Staged update confirmed for ID </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] ✅ apply_json_patch_and_log completed successfully&quot;</span><span class="p">)</span>

    <span class="c1"># 🆕 Commit the database transaction to persist changes</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] About to commit database session&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] ✅ Database session committed successfully&quot;</span><span class="p">)</span>

    <span class="c1"># Move the staged JSON file to the processed directory</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">staged_path</span><span class="p">,</span> <span class="n">processed_path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] ✅ Moved staged file to processed: </span><span class="si">{</span><span class="n">processed_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Successfully updated record </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span><span class="si">}</span><span class="s2"> fields changed. Staged file moved to processed directory.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span>

  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Rollback on error to prevent partial commits</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] ❌ Error during database update: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[confirm_staged] Full exception details:&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error applying updates for ID </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.upload_file_staged&quot;</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.upload_file_staged&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.delete_testing_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_testing_range</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Developer utility: Delete testing rows in a specified id_incidence range.</p>
<p>NOTE: This is a developer/destructive route, not covered by E2E tests by design.</p>
<p>GET: Show form to specify min_id, max_id, and dry_run.
POST: Run delete_testing_rows and show summary/results, including id_incidences if dry run.</p>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/delete_testing_range&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_testing_range</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Developer utility: Delete testing rows in a specified id_incidence range.</span>

<span class="sd">  NOTE: This is a developer/destructive route, not covered by E2E tests by design.</span>

<span class="sd">  GET: Show form to specify min_id, max_id, and dry_run.</span>
<span class="sd">  POST: Run delete_testing_rows and show summary/results, including id_incidences if dry run.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_app</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: delete_testing_range&quot;</span><span class="p">)</span>

  <span class="n">base</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">min_id</span> <span class="o">=</span> <span class="mi">1000000</span>
  <span class="n">max_id</span> <span class="o">=</span> <span class="mi">2000000</span>
  <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="n">submitted</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">portal_updates_ids</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">incidences_ids</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">min_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_id&#39;</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">))</span>
      <span class="n">max_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_id&#39;</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">))</span>
      <span class="n">dry_run</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dry_run&#39;</span><span class="p">))</span>
      <span class="n">submitted</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="n">min_id</span> <span class="o">&lt;</span> <span class="mi">1000000</span> <span class="ow">or</span> <span class="n">max_id</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Both min and max id_incidence must be at least 1000000.&quot;</span>
      <span class="k">elif</span> <span class="n">min_id</span> <span class="o">&gt;</span> <span class="n">max_id</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;min_id cannot be greater than max_id.&quot;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
          <span class="c1"># Get the IDs that would be deleted</span>
          <span class="n">preview</span> <span class="o">=</span> <span class="n">list_testing_rows</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">min_id</span><span class="p">,</span> <span class="n">max_id</span><span class="p">)</span>
          <span class="n">portal_updates_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id_incidence&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">preview</span><span class="p">[</span><span class="s1">&#39;portal_updates&#39;</span><span class="p">]))</span>
          <span class="n">incidences_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id_incidence&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">preview</span><span class="p">[</span><span class="s1">&#39;incidences&#39;</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">delete_testing_rows</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">min_id</span><span class="p">,</span> <span class="n">max_id</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="n">instructions</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;&lt;ul&gt;&quot;</span>
    <span class="s2">&quot;&lt;li&gt;&lt;b&gt;Use this tool to delete test rows from the portal_updates and incidences tables.&lt;/b&gt;&lt;/li&gt;&quot;</span>
    <span class="s2">&quot;&lt;li&gt;Specify a min and max id_incidence (both must be at least 1000000).&lt;/li&gt;&quot;</span>
    <span class="s2">&quot;&lt;li&gt;Check &#39;Dry Run&#39; to preview what would be deleted without making changes.&lt;/li&gt;&quot;</span>
    <span class="s2">&quot;&lt;li&gt;&lt;b&gt;Warning:&lt;/b&gt; This cannot delete real data (id_incidence &lt; 1000000 is not allowed).&lt;/li&gt;&quot;</span>
    <span class="s2">&quot;&lt;li&gt;For safety, always do a dry run first!&lt;/li&gt;&quot;</span>
    <span class="s2">&quot;&lt;/ul&gt;&quot;</span>
  <span class="p">)</span>

  <span class="c1"># Remove summarize_ids and always pass full lists</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
    <span class="s1">&#39;delete_testing_range.html&#39;</span><span class="p">,</span>
    <span class="n">min_id</span><span class="o">=</span><span class="n">min_id</span><span class="p">,</span>
    <span class="n">max_id</span><span class="o">=</span><span class="n">max_id</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
    <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span>
    <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
    <span class="n">submitted</span><span class="o">=</span><span class="n">submitted</span><span class="p">,</span>
    <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
    <span class="n">portal_updates_ids</span><span class="o">=</span><span class="n">portal_updates_ids</span><span class="p">,</span>
    <span class="n">incidences_ids</span><span class="o">=</span><span class="n">incidences_ids</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.diagnostics" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">diagnostics</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Display developer diagnostics and runtime information.</p>
<p>NOTE: This is a developer-only route, not covered by E2E tests by design.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML diagnostics page.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.diagnostics--in-browser-get-diagnostics">In browser: GET /diagnostics</h3>
<h3 id="arb.portal.routes.diagnostics--returns-html-diagnostics-info">Returns: HTML diagnostics info</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span>
<span class="normal">992</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/diagnostics&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">diagnostics</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Display developer diagnostics and runtime information.</span>

<span class="sd">  NOTE: This is a developer-only route, not covered by E2E tests by design.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML diagnostics page.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /diagnostics</span>
<span class="sd">    # Returns: HTML diagnostics info</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: diagnostics&quot;</span><span class="p">)</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">find_auto_increment_value</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;incidences&quot;</span><span class="p">,</span> <span class="s2">&quot;id_incidence&quot;</span><span class="p">)</span>

  <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;Diagnostic Results=&lt;/strong&gt;&lt;/p&gt; &lt;p&gt;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;diagnostics.html&#39;</span><span class="p">,</span>
                         <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Auto-Increment Check&quot;</span><span class="p">,</span>
                         <span class="n">subheader</span><span class="o">=</span><span class="s2">&quot;Next available ID value in the &#39;incidences&#39; table.&quot;</span><span class="p">,</span>
                         <span class="n">html_content</span><span class="o">=</span><span class="n">html_content</span><span class="p">,</span>
                         <span class="n">modal_title</span><span class="o">=</span><span class="s2">&quot;Success&quot;</span><span class="p">,</span>
                         <span class="n">modal_message</span><span class="o">=</span><span class="s2">&quot;Diagnostics completed successfully.&quot;</span><span class="p">,</span>
                         <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.discard_staged_update" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">discard_staged_update</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Discard a staged update for a specific incidence ID and filename.
CSRF is disabled for this route.</p>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@csrf</span><span class="o">.</span><span class="n">exempt</span>
<span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/discard_staged_update/&lt;int:id_&gt;/&lt;filename&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">discard_staged_update</span><span class="p">(</span><span class="n">id_</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResponseReturnValue</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Discard a staged update for a specific incidence ID and filename.</span>
<span class="sd">  CSRF is disabled for this route.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: discard_staged_update with id_: </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2"> and filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="kn">import</span><span class="w"> </span><span class="nn">unicodedata</span>
  <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
  <span class="n">staging_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">get_upload_folder</span><span class="p">())</span> <span class="o">/</span> <span class="s2">&quot;staging&quot;</span>
  <span class="c1"># Normalize filename for cross-platform compatibility</span>
  <span class="n">safe_filename</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFC&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
  <span class="n">staged_file</span> <span class="o">=</span> <span class="n">staging_dir</span> <span class="o">/</span> <span class="n">safe_filename</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] Route called: id_=</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">, filename=&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;, safe_filename=&#39;</span><span class="si">{</span><span class="n">safe_filename</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] Starting deletion for: </span><span class="si">{</span><span class="n">staged_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] File exists before deletion: </span><span class="si">{</span><span class="n">staged_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">staged_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
      <span class="n">staged_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] File deleted: </span><span class="si">{</span><span class="n">staged_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] File not found for deletion: </span><span class="si">{</span><span class="n">staged_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] Exception during file deletion: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] File exists after deletion: </span><span class="si">{</span><span class="n">staged_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] Completed discard_staged_update for: </span><span class="si">{</span><span class="n">staged_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="c1"># Sleep briefly to ensure filesystem updates propagate (for test timing)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DISCARD] Returning redirect to /list_staged&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;main.list_staged&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.export_portal_updates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_portal_updates</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Export all portal update log entries as a CSV file.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>Response</code></b>(                  <code><span title="flask.Response">Response</span></code>
)              –
              <div class="doc-md-description">
                <p>CSV file download of portal update logs.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Respects filters set in the <code>/portal_updates</code> page.</li>
<li>Uses standard CSV headers and UTF-8 encoding.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/portal_updates/export&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">export_portal_updates</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Export all portal update log entries as a CSV file.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Response: CSV file download of portal update logs.</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Respects filters set in the `/portal_updates` page.</span>
<span class="sd">    - Uses standard CSV headers and UTF-8 encoding.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: export_portal_updates&quot;</span><span class="p">)</span>

  <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PortalUpdate</span><span class="p">)</span>
  <span class="n">query</span> <span class="o">=</span> <span class="n">apply_portal_update_filters</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">PortalUpdate</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

  <span class="n">updates</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">PortalUpdate</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

  <span class="n">si</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
  <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
  <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;old_value&quot;</span><span class="p">,</span> <span class="s2">&quot;new_value&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;comments&quot;</span><span class="p">,</span> <span class="s2">&quot;id_incidence&quot;</span><span class="p">])</span>

  <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">:</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span>
      <span class="n">u</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
      <span class="n">u</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
      <span class="n">u</span><span class="o">.</span><span class="n">old_value</span><span class="p">,</span>
      <span class="n">u</span><span class="o">.</span><span class="n">new_value</span><span class="p">,</span>
      <span class="n">u</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
      <span class="n">u</span><span class="o">.</span><span class="n">comments</span><span class="p">,</span>
      <span class="n">u</span><span class="o">.</span><span class="n">id_incidence</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="p">])</span>

  <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
    <span class="n">si</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span>
    <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;text/csv&quot;</span><span class="p">,</span>
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Disposition&quot;</span><span class="p">:</span> <span class="s2">&quot;attachment; filename=portal_updates_export.csv&quot;</span><span class="p">}</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.incidence_delete" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">incidence_delete</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Delete a specified incidence from the database.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id_</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
                <p>Primary key of the incidence to delete.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>Response</code></b>(                  <code><span title="flask.typing.ResponseReturnValue">ResponseReturnValue</span></code>
)              –
              <div class="doc-md-description">
                <p>Redirect to the homepage after deletion.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.incidence_delete--in-browser-post-incidence_delete123">In browser: POST /incidence_delete/123/</h3>
<h3 id="arb.portal.routes.incidence_delete--redirects-to">Redirects to: /</h3>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Future: consider adding authorization (e.g., CARB password) to restrict access.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/incidence_delete/&lt;int:id_&gt;/&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">incidence_delete</span><span class="p">(</span><span class="n">id_</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResponseReturnValue</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Delete a specified incidence from the database.</span>

<span class="sd">  Args:</span>
<span class="sd">    id_ (int): Primary key of the incidence to delete.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Response: Redirect to the homepage after deletion.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: POST /incidence_delete/123/</span>
<span class="sd">    # Redirects to: /</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Future: consider adding authorization (e.g., CARB password) to restrict access.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: incidence_delete with id= </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>

  <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;incidences&#39;</span>
  <span class="n">table</span> <span class="o">=</span> <span class="n">get_class_from_table_name</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Could not get table class for incidences&quot;</span><span class="p">)</span>

  <span class="c1"># Type cast to help with SQLAlchemy typing</span>
  <span class="n">table_class</span> <span class="o">=</span> <span class="n">table</span>  <span class="c1"># type: Any</span>
  <span class="n">model_row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">table_class</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>

  <span class="c1"># todo - ensure portal changes are properly updated</span>
  <span class="n">arb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">sql_alchemy</span><span class="o">.</span><span class="n">delete_commit_and_log_model</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
                                                    <span class="n">model_row</span><span class="p">,</span>
                                                    <span class="n">comment</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Deleting incidence row </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.index&#39;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.incidence_update" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">incidence_update</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Display and edit a specific incidence record by ID.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id_</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
                <p>Primary key of the incidence to edit.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="flask.Response">Response</span>]</code>
              –
              <div class="doc-md-description">
                <p>str|Response: Rendered HTML of the feedback form for the selected incidence,
   or a redirect to the upload page if the ID is missing.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code>500 Internal Server Error</code>
              –
              <div class="doc-md-description">
                <p>If multiple records are found for the same ID.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.incidence_update--in-browser-get-incidence_update123">In browser: GET /incidence_update/123/</h3>
<h3 id="arb.portal.routes.incidence_update--returns-html-form-for-editing-incidence-123">Returns: HTML form for editing incidence 123</h3>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Redirects if the ID is not found in the database.</li>
<li>Assumes each incidence ID is unique.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/incidence_update/&lt;int:id_&gt;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">incidence_update</span><span class="p">(</span><span class="n">id_</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Response</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Display and edit a specific incidence record by ID.</span>

<span class="sd">  Args:</span>
<span class="sd">    id_ (int): Primary key of the incidence to edit.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str|Response: Rendered HTML of the feedback form for the selected incidence,</span>
<span class="sd">         or a redirect to the upload page if the ID is missing.</span>

<span class="sd">  Raises:</span>
<span class="sd">    500 Internal Server Error: If multiple records are found for the same ID.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /incidence_update/123/</span>
<span class="sd">    # Returns: HTML form for editing incidence 123</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Redirects if the ID is not found in the database.</span>
<span class="sd">    - Assumes each incidence ID is unique.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: incidence_update with id= </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;incidences&#39;</span>
  <span class="n">table</span> <span class="o">=</span> <span class="n">get_class_from_table_name</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

  <span class="c1"># get_or_404 uses the tables primary key</span>
  <span class="c1"># model_row = db.session.query(table).get_or_404(id_)</span>
  <span class="c1"># todo turn this into a get and if it is null, then redirect? to the spreadsheet upload</span>
  <span class="c1"># todo consider turning into one_or_none and have error handling</span>
  <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Could not get table class for incidences&quot;</span><span class="p">)</span>

  <span class="c1"># Type cast to help with SQLAlchemy typing</span>
  <span class="n">table_class</span> <span class="o">=</span> <span class="n">table</span>  <span class="c1"># type: Any</span>
  <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">table_class</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">id_incidence</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A request was made to edit a non-existent id_incidence (</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">).  Consider uploading the incidence by importing a spreadsheet.&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.upload_file&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">))</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Multiple rows found for id=</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">model_row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="n">sector</span><span class="p">,</span> <span class="n">sector_type</span> <span class="o">=</span> <span class="n">get_sector_info</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">id_</span><span class="p">)</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;calling incidence_prep()&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">incidence_prep</span><span class="p">(</span><span class="n">model_row</span><span class="p">,</span>
                        <span class="n">crud_type</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">,</span>
                        <span class="n">sector_type</span><span class="o">=</span><span class="n">sector_type</span><span class="p">,</span>
                        <span class="n">default_dropdown</span><span class="o">=</span><span class="n">PLEASE_SELECT</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.index" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">index</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Display the homepage with a list of all existing incidence records.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML for the homepage with incidence records.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.index--in-browser-get">In browser: GET /</h3>
<h3 id="arb.portal.routes.index--returns-html-page-with-table-of-incidences">Returns: HTML page with table of incidences</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Display the homepage with a list of all existing incidence records.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML for the homepage with incidence records.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /</span>
<span class="sd">    # Returns: HTML page with table of incidences</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: index.&quot;</span><span class="p">)</span>

  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;incidences&#39;</span>
  <span class="n">colum_name_pk</span> <span class="o">=</span> <span class="s1">&#39;id_incidence&#39;</span>
  <span class="n">rows</span> <span class="o">=</span> <span class="n">get_rows_by_table_name</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">colum_name_pk</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">model_rows</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.java_script_diagnostic_test" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">java_script_diagnostic_test</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Render a simple page for testing JavaScript diagnostics logging (frontend and backend).</p>
<p>NOTE: This is a developer-only route, not covered by E2E tests by design.</p>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/java_script_diagnostic_test&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">java_script_diagnostic_test</span><span class="p">():</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Render a simple page for testing JavaScript diagnostics logging (frontend and backend).</span>

<span class="sd">  NOTE: This is a developer-only route, not covered by E2E tests by design.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: java_script_diagnostic_test&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;java_script_diagnostic_test.html&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.js_diagnostic_log" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">js_diagnostic_log</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <h3 id="arb.portal.routes.js_diagnostic_log--javascript-diagnostics-logging-endpoint">JavaScript Diagnostics Logging Endpoint</h3>
<p>NOTE: This is a developer-only route, not covered by E2E tests by design.</p>


<details class="purpose" open>
  <summary>Purpose</summary>
  <p>This route allows frontend JavaScript code to send diagnostic or debug messages directly to the backend server.
These messages are then written to the backend log file, making it possible to correlate frontend/browser events
with backend activity, errors, or user actions. This is especially useful for debugging issues that are hard to
capture with browser console logs alone (e.g., page reloads, E2E tests, or user-reported problems).</p>
</details>        <p>How to Use (Frontend JavaScript):
    Use the provided JS helper function (see below) to send a POST request to this endpoint:</p>
<pre><code>Example JS function:
    function sendJsDiagnostic(msg, extra) {
        fetch('/js_diagnostic_log', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({msg, ts: new Date().toISOString(), ...extra})
        });
    }

Example usage:
    sendJsDiagnostic('User clicked discard', {action: '/discard_staged_update/0/file.json', userId: 123});
</code></pre>
<p>Expected Payload (JSON):
    {
        "msg": "A human-readable message (required)",
        "ts": "ISO timestamp (optional, will be included in log if present)",
        ... any other key-value pairs (optional, will be logged as 'extra')
    }</p>


<details class="what-happens" open>
  <summary>What Happens</summary>
  <ul>
<li>The backend receives the POST request and parses the JSON payload.</li>
<li>It extracts the 'msg' (message), 'ts' (timestamp), and any other fields (as 'extra').</li>
<li>It writes a log entry to the backend log file in the format:
    [JS_DIAG][timestamp] message | extra: {...}</li>
<li>Returns a simple JSON response: {"status": "ok"}</li>
</ul>
</details>

<details class="why-use-this" open>
  <summary>Why Use This</summary>
  <ul>
<li>Console logs in the browser are lost on navigation/reload and are not visible to backend developers.</li>
<li>This route allows you to persistently log important frontend events, errors, or user actions for later analysis.</li>
<li>Especially useful for E2E testing, debugging user issues, or tracking hard-to-reproduce bugs.</li>
</ul>
</details>

<details class="security-note" open>
  <summary>Security Note</summary>
  <ul>
<li>This endpoint is for diagnostics only. Do not send sensitive user data.</li>
<li>Rate limiting or authentication can be added if needed for production.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/js_diagnostic_log&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">js_diagnostic_log</span><span class="p">():</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  JavaScript Diagnostics Logging Endpoint</span>
<span class="sd">  =======================================</span>
<span class="sd">  NOTE: This is a developer-only route, not covered by E2E tests by design.</span>

<span class="sd">  Purpose:</span>
<span class="sd">      This route allows frontend JavaScript code to send diagnostic or debug messages directly to the backend server.</span>
<span class="sd">      These messages are then written to the backend log file, making it possible to correlate frontend/browser events</span>
<span class="sd">      with backend activity, errors, or user actions. This is especially useful for debugging issues that are hard to</span>
<span class="sd">      capture with browser console logs alone (e.g., page reloads, E2E tests, or user-reported problems).</span>

<span class="sd">  How to Use (Frontend JavaScript):</span>
<span class="sd">      Use the provided JS helper function (see below) to send a POST request to this endpoint:</span>

<span class="sd">      Example JS function:</span>
<span class="sd">          function sendJsDiagnostic(msg, extra) {</span>
<span class="sd">              fetch(&#39;/js_diagnostic_log&#39;, {</span>
<span class="sd">                  method: &#39;POST&#39;,</span>
<span class="sd">                  headers: {&#39;Content-Type&#39;: &#39;application/json&#39;},</span>
<span class="sd">                  body: JSON.stringify({msg, ts: new Date().toISOString(), ...extra})</span>
<span class="sd">              });</span>
<span class="sd">          }</span>

<span class="sd">      Example usage:</span>
<span class="sd">          sendJsDiagnostic(&#39;User clicked discard&#39;, {action: &#39;/discard_staged_update/0/file.json&#39;, userId: 123});</span>

<span class="sd">  Expected Payload (JSON):</span>
<span class="sd">      {</span>
<span class="sd">          &quot;msg&quot;: &quot;A human-readable message (required)&quot;,</span>
<span class="sd">          &quot;ts&quot;: &quot;ISO timestamp (optional, will be included in log if present)&quot;,</span>
<span class="sd">          ... any other key-value pairs (optional, will be logged as &#39;extra&#39;)</span>
<span class="sd">      }</span>

<span class="sd">  What Happens:</span>
<span class="sd">      - The backend receives the POST request and parses the JSON payload.</span>
<span class="sd">      - It extracts the &#39;msg&#39; (message), &#39;ts&#39; (timestamp), and any other fields (as &#39;extra&#39;).</span>
<span class="sd">      - It writes a log entry to the backend log file in the format:</span>
<span class="sd">          [JS_DIAG][timestamp] message | extra: {...}</span>
<span class="sd">      - Returns a simple JSON response: {&quot;status&quot;: &quot;ok&quot;}</span>

<span class="sd">  Why Use This:</span>
<span class="sd">      - Console logs in the browser are lost on navigation/reload and are not visible to backend developers.</span>
<span class="sd">      - This route allows you to persistently log important frontend events, errors, or user actions for later analysis.</span>
<span class="sd">      - Especially useful for E2E testing, debugging user issues, or tracking hard-to-reproduce bugs.</span>

<span class="sd">  Security Note:</span>
<span class="sd">      - This endpoint is for diagnostics only. Do not send sensitive user data.</span>
<span class="sd">      - Rate limiting or authentication can be added if needed for production.</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: js_diagnostic_log&quot;</span><span class="p">)</span>

  <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="s1">&#39;[NO MSG]&#39;</span><span class="p">)</span>
  <span class="n">ts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
  <span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">)}</span>
  <span class="n">log_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[JS_DIAG]</span><span class="si">{</span><span class="s1">&#39;[&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
    <span class="n">log_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; | extra: </span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.landfill_incidence_create" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">landfill_incidence_create</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Create a new dummy Landfill incidence and redirect to its edit form.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>Response</code></b>(                  <code><span title="flask.Response">Response</span></code>
)              –
              <div class="doc-md-description">
                <p>Redirect to the <code>incidence_update</code> page for the newly created ID.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.landfill_incidence_create--in-browser-post-landfill_incidence_create">In browser: POST /landfill_incidence_create/</h3>
<h3 id="arb.portal.routes.landfill_incidence_create--redirects-to-incidence_update">Redirects to: /incidence_update/<new_id>/</h3>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Dummy data is loaded from <code>db_hardcoded.get_landfill_dummy_form_data()</code>.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/landfill_incidence_create/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">landfill_incidence_create</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Create a new dummy Landfill incidence and redirect to its edit form.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Response: Redirect to the `incidence_update` page for the newly created ID.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: POST /landfill_incidence_create/</span>
<span class="sd">    # Redirects to: /incidence_update/&lt;new_id&gt;/</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Dummy data is loaded from `db_hardcoded.get_landfill_dummy_form_data()`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: landfill_incidence_create.&quot;</span><span class="p">)</span>

  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;incidences&#39;</span>
  <span class="n">col_name</span> <span class="o">=</span> <span class="s1">&#39;misc_json&#39;</span>

  <span class="n">data_dict</span> <span class="o">=</span> <span class="n">arb</span><span class="o">.</span><span class="n">portal</span><span class="o">.</span><span class="n">db_hardcoded</span><span class="o">.</span><span class="n">get_landfill_dummy_form_data</span><span class="p">()</span>

  <span class="n">id_</span> <span class="o">=</span> <span class="n">dict_to_database</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
                         <span class="n">base</span><span class="p">,</span>
                         <span class="n">data_dict</span><span class="p">,</span>
                         <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                         <span class="n">json_field</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
                         <span class="p">)</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;landfill_incidence_create() - leaving.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.incidence_update&#39;</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">id_</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.list_staged" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_staged</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>List all staged files available for review or processing.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="flask.typing.ResponseReturnValue">ResponseReturnValue</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML showing all staged files.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/list_staged&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_staged</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ResponseReturnValue</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  List all staged files available for review or processing.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML showing all staged files.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: list_staged&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[LIST_STAGED] Route called&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;list_staged route called&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;[DEBUG] /list_staged route called&#39;</span><span class="p">)</span>

  <span class="n">staging_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">get_upload_folder</span><span class="p">())</span> <span class="o">/</span> <span class="s2">&quot;staging&quot;</span>
  <span class="n">staged_files</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">malformed_files</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="n">staging_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">staging_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">name</span>
      <span class="n">id_incidence</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">sector</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to extract ID from filename (format: id_XXXX_ts_YYYYMMDD_HHMMSS.json)</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;id_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;_ts_&quot;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
          <span class="n">id_part</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_ts_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">id_incidence</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">id_part</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;id_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="c1"># Try to load metadata to get sector and check for required fields</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">json_data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">json_load_with_meta</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
          <span class="n">base_misc_json</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_misc_json&quot;</span><span class="p">,</span> <span class="p">{})</span>
          <span class="n">sector</span> <span class="o">=</span> <span class="n">base_misc_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sector&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
          <span class="c1"># Check for required field: id_incidence must be a positive integer</span>
          <span class="n">id_candidate</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="c1"># Try to get id_incidence from JSON if not from filename</span>
          <span class="k">if</span> <span class="n">id_incidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">id_candidate</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id_incidence&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_candidate</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">id_candidate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">id_incidence</span> <span class="o">=</span> <span class="n">id_candidate</span>
          <span class="c1"># If still not valid, treat as malformed</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">id_incidence</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">id_incidence</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing or invalid id_incidence&quot;</span><span class="p">)</span>
          <span class="n">staged_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s1">&#39;id_incidence&#39;</span><span class="p">:</span> <span class="n">id_incidence</span><span class="p">,</span>
            <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="n">sector</span><span class="p">,</span>
            <span class="s1">&#39;file_size&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
            <span class="s1">&#39;modified_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">),</span>
            <span class="s1">&#39;malformed&#39;</span><span class="p">:</span> <span class="kc">False</span>
          <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">meta_exc</span><span class="p">:</span>
          <span class="c1"># If JSON loads but required fields are missing, treat as malformed</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Malformed staged file (missing fields) </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">meta_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="n">malformed_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s1">&#39;file_size&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
            <span class="s1">&#39;modified_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">),</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Missing required fields: </span><span class="si">{</span><span class="n">meta_exc</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="p">})</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not process staged file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">malformed_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
          <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
          <span class="s1">&#39;file_size&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
          <span class="s1">&#39;modified_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">),</span>
          <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">})</span>

  <span class="c1"># Sort by modification time (newest first)</span>
  <span class="n">staged_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;modified_time&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">malformed_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;modified_time&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DEBUG] /list_staged rendering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">staged_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> staged, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">malformed_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> malformed files&#39;</span><span class="p">)</span>
  <span class="c1"># Always pass both variables, even if empty</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;staged_list.html&#39;</span><span class="p">,</span> <span class="n">staged_files</span><span class="o">=</span><span class="n">staged_files</span><span class="p">,</span> <span class="n">malformed_files</span><span class="o">=</span><span class="n">malformed_files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.list_uploads" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_uploads</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>List all files in the upload directory.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML showing all uploaded Excel files available on disk.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.list_uploads--in-browser-get-list_uploads">In browser: GET /list_uploads</h3>
<h3 id="arb.portal.routes.list_uploads--returns-html-page-listing-uploaded-files">Returns: HTML page listing uploaded files</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/list_uploads&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_uploads</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  List all files in the upload directory.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML showing all uploaded Excel files available on disk.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /list_uploads</span>
<span class="sd">    # Returns: HTML page listing uploaded files</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: list_uploads&quot;</span><span class="p">)</span>

  <span class="n">upload_folder</span> <span class="o">=</span> <span class="n">get_upload_folder</span><span class="p">()</span>
  <span class="c1"># up_dir = Path(&quot;portal/static/uploads&quot;)</span>
  <span class="c1"># print(f&quot;{type(up_dir)=}: {up_dir=}&quot;)</span>
  <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">upload_folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_file</span><span class="p">()]</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">files</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;uploads_list.html&#39;</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.og_incidence_create" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">og_incidence_create</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Create a new dummy Oil &amp; Gas incidence and redirect to its edit form.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>Response</code></b>(                  <code><span title="flask.Response">Response</span></code>
)              –
              <div class="doc-md-description">
                <p>Redirect to the <code>incidence_update</code> page for the newly created ID.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.og_incidence_create--in-browser-post-og_incidence_create">In browser: POST /og_incidence_create/</h3>
<h3 id="arb.portal.routes.og_incidence_create--redirects-to-incidence_update">Redirects to: /incidence_update/<new_id>/</h3>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Dummy data is loaded from <code>db_hardcoded.get_og_dummy_form_data()</code>.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/og_incidence_create/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">og_incidence_create</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Create a new dummy Oil &amp; Gas incidence and redirect to its edit form.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Response: Redirect to the `incidence_update` page for the newly created ID.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: POST /og_incidence_create/</span>
<span class="sd">    # Redirects to: /incidence_update/&lt;new_id&gt;/</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Dummy data is loaded from `db_hardcoded.get_og_dummy_form_data()`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: og_incidence_create.&quot;</span><span class="p">)</span>

  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;incidences&#39;</span>
  <span class="n">col_name</span> <span class="o">=</span> <span class="s1">&#39;misc_json&#39;</span>

  <span class="n">data_dict</span> <span class="o">=</span> <span class="n">arb</span><span class="o">.</span><span class="n">portal</span><span class="o">.</span><span class="n">db_hardcoded</span><span class="o">.</span><span class="n">get_og_dummy_form_data</span><span class="p">()</span>

  <span class="n">id_</span> <span class="o">=</span> <span class="n">dict_to_database</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
                         <span class="n">base</span><span class="p">,</span>
                         <span class="n">data_dict</span><span class="p">,</span>
                         <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                         <span class="n">json_field</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
                         <span class="p">)</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;og_incidence_create() - leaving.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.incidence_update&#39;</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">id_</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.review_staged" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">review_staged</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Review the contents of a staged file for a specific incidence ID.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id_</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
                <p>Incidence ID associated with the staged file.</p>
              </div>
            </li>
            <li>
              <b><code>filename</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>Name of the staged file to review.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="str">str</span> | <span title="flask.Response">Response</span></code>
              –
              <div class="doc-md-description">
                <p>str|Response: Rendered HTML for file review, or redirect if not found.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.review_staged--in-browser-get-review_staged123myfilexlsx">In browser: GET /review_staged/123/myfile.xlsx</h3>
<h3 id="arb.portal.routes.review_staged--returns-html-review-page-for-the-file">Returns: HTML review page for the file</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/review_staged/&lt;int:id_&gt;/&lt;filename&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">review_staged</span><span class="p">(</span><span class="n">id_</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Review the contents of a staged file for a specific incidence ID.</span>

<span class="sd">  Args:</span>
<span class="sd">    id_ (int): Incidence ID associated with the staged file.</span>
<span class="sd">    filename (str): Name of the staged file to review.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str|Response: Rendered HTML for file review, or redirect if not found.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /review_staged/123/myfile.xlsx</span>
<span class="sd">    # Returns: HTML review page for the file</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: review_staged with id_: </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2"> and filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">staging_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">get_upload_folder</span><span class="p">())</span> <span class="o">/</span> <span class="s2">&quot;staging&quot;</span>
  <span class="n">staged_json_path</span> <span class="o">=</span> <span class="n">staging_dir</span> <span class="o">/</span> <span class="n">filename</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">staged_json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Staged JSON file not found: </span><span class="si">{</span><span class="n">staged_json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;review_staged.html&quot;</span><span class="p">,</span>
                           <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;No staged data found for ID </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                           <span class="n">is_new_row</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">id_incidence</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span>
                           <span class="n">staged_fields</span><span class="o">=</span><span class="p">[],</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span>
                           <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">staged_data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">json_load_with_meta</span><span class="p">(</span><span class="n">staged_json_path</span><span class="p">)</span>
    <span class="n">staged_payload</span> <span class="o">=</span> <span class="n">extract_tab_and_sector</span><span class="p">(</span><span class="n">staged_data</span><span class="p">,</span> <span class="n">tab_name</span><span class="o">=</span><span class="s2">&quot;Feedback Form&quot;</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error loading staged JSON&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;review_staged.html&quot;</span><span class="p">,</span>
                           <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Could not load staged data.&quot;</span><span class="p">,</span>
                           <span class="n">is_new_row</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">id_incidence</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span>
                           <span class="n">staged_fields</span><span class="o">=</span><span class="p">[],</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span>
                           <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

  <span class="n">model</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">is_new_row</span> <span class="o">=</span> <span class="n">get_ensured_row</span><span class="p">(</span>
    <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
    <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;incidences&quot;</span><span class="p">,</span>
    <span class="n">primary_key_name</span><span class="o">=</span><span class="s2">&quot;id_incidence&quot;</span><span class="p">,</span>
    <span class="n">id_</span><span class="o">=</span><span class="n">id_</span>
  <span class="p">)</span>

  <span class="n">db_json</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;misc_json&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
  <span class="n">staged_fields</span> <span class="o">=</span> <span class="n">compute_field_differences</span><span class="p">(</span><span class="n">new_data</span><span class="o">=</span><span class="n">staged_payload</span><span class="p">,</span> <span class="n">existing_data</span><span class="o">=</span><span class="n">db_json</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">is_new_row</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Staged ID </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2"> did not exist in DB. A blank row was created for review.&quot;</span><span class="p">)</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computed </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;changed&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">staged_fields</span><span class="p">)</span><span class="si">}</span><span class="s2"> changes across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">staged_fields</span><span class="p">)</span><span class="si">}</span><span class="s2"> fields&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
    <span class="s2">&quot;review_staged.html&quot;</span><span class="p">,</span>
    <span class="n">id_incidence</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span>
    <span class="n">staged_fields</span><span class="o">=</span><span class="n">staged_fields</span><span class="p">,</span>
    <span class="n">is_new_row</span><span class="o">=</span><span class="n">is_new_row</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.search" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">search</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Search for incidences or updates in the portal database.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML search results page.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Currently echoes the user-submitted query string.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/search/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Search for incidences or updates in the portal database.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML search results page.</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Currently echoes the user-submitted query string.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: search&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">search_string</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;navbar_search&#39;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">search_string</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;search.html&#39;</span><span class="p">,</span>
                         <span class="n">search_string</span><span class="o">=</span><span class="n">search_string</span><span class="p">,</span>
                         <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.serve_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">serve_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Serve a file from the uploads directory.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>filename</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>Name of the file to serve.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>Response</code></b>(                  <code><span title="flask.Response">Response</span></code>
)              –
              <div class="doc-md-description">
                <p>File response for download or viewing in browser.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.serve_file--in-browser-get-serve_filemyfilexlsx">In browser: GET /serve_file/myfile.xlsx</h3>
<h3 id="arb.portal.routes.serve_file--returns-file-download-or-inline-view">Returns: File download or inline view</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/serve_file/&lt;path:filename&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serve_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Serve a file from the uploads directory.</span>

<span class="sd">  Args:</span>
<span class="sd">    filename (str): Name of the file to serve.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Response: File response for download or viewing in browser.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /serve_file/myfile.xlsx</span>
<span class="sd">    # Returns: File download or inline view</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: serve_file with filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">upload_folder</span> <span class="o">=</span> <span class="n">get_upload_folder</span><span class="p">()</span>
  <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">upload_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.show_database_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_database_structure</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Show the structure of the portal database (tables, columns, types).</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML of database structure.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.show_database_structure--in-browser-get-show_database_structure">In browser: GET /show_database_structure</h3>
<h3 id="arb.portal.routes.show_database_structure--returns-html-with-database-structure">Returns: HTML with database structure</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/show_database_structure&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_database_structure</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Show the structure of the portal database (tables, columns, types).</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML of database structure.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /show_database_structure</span>
<span class="sd">    # Returns: HTML with database structure</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: show_database_structure&quot;</span><span class="p">)</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">obj_to_html</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">db_column_types</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;Postgres Database Structure=&lt;/strong&gt;&lt;/p&gt; &lt;p&gt;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;diagnostics.html&#39;</span><span class="p">,</span>
                         <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Database Structure Overview&quot;</span><span class="p">,</span>
                         <span class="n">subheader</span><span class="o">=</span><span class="s2">&quot;Reflecting SQLAlchemy model metadata.&quot;</span><span class="p">,</span>
                         <span class="n">html_content</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                         <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.show_dropdown_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_dropdown_dict</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Show the current dropdown dictionary used in forms.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML of dropdown dictionary.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Useful for verifying dropdown contents used in WTForms.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/show_dropdown_dict&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_dropdown_dict</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Show the current dropdown dictionary used in forms.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML of dropdown dictionary.</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Useful for verifying dropdown contents used in WTForms.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: show_dropdown_dict&quot;</span><span class="p">)</span>

  <span class="c1"># update drop-down tables</span>
  <span class="n">Globals</span><span class="o">.</span><span class="n">load_drop_downs</span><span class="p">(</span><span class="n">current_app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
  <span class="n">result1</span> <span class="o">=</span> <span class="n">obj_to_html</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">drop_downs</span><span class="p">)</span>
  <span class="n">result2</span> <span class="o">=</span> <span class="n">obj_to_html</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">drop_downs_contingent</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;Globals.drop_downs=&lt;/strong&gt;&lt;/p&gt; &lt;p&gt;</span><span class="si">{</span><span class="n">result1</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;Globals.drop_downs_contingent=&lt;/strong&gt;&lt;/p&gt; &lt;p&gt;</span><span class="si">{</span><span class="n">result2</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;diagnostics.html&#39;</span><span class="p">,</span>
                         <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Dropdown Dictionaries&quot;</span><span class="p">,</span>
                         <span class="n">subheader</span><span class="o">=</span><span class="s2">&quot;Loaded dropdown values and contingent mappings.&quot;</span><span class="p">,</span>
                         <span class="n">html_content</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                         <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.show_feedback_form_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_feedback_form_structure</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Show the structure of the feedback form (fields, types, validators).</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML of feedback form structure.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.show_feedback_form_structure--in-browser-get-show_feedback_form_structure">In browser: GET /show_feedback_form_structure</h3>
<h3 id="arb.portal.routes.show_feedback_form_structure--returns-html-with-feedback-form-structure">Returns: HTML with feedback form structure</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/show_feedback_form_structure&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_feedback_form_structure</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Show the structure of the feedback form (fields, types, validators).</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML of feedback form structure.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /show_feedback_form_structure</span>
<span class="sd">    # Returns: HTML with feedback form structure</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: show_feedback_form_structure&quot;</span><span class="p">)</span>

  <span class="n">form1</span> <span class="o">=</span> <span class="n">OGFeedback</span><span class="p">()</span>
  <span class="n">fields1</span> <span class="o">=</span> <span class="n">get_wtforms_fields</span><span class="p">(</span><span class="n">form1</span><span class="p">)</span>
  <span class="n">result1</span> <span class="o">=</span> <span class="n">obj_to_html</span><span class="p">(</span><span class="n">fields1</span><span class="p">)</span>

  <span class="n">form2</span> <span class="o">=</span> <span class="n">LandfillFeedback</span><span class="p">()</span>
  <span class="n">fields2</span> <span class="o">=</span> <span class="n">get_wtforms_fields</span><span class="p">(</span><span class="n">form2</span><span class="p">)</span>
  <span class="n">result2</span> <span class="o">=</span> <span class="n">obj_to_html</span><span class="p">(</span><span class="n">fields2</span><span class="p">)</span>

  <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;WTF OGFeedback Form Structure=&lt;/strong&gt;&lt;/p&gt; &lt;p&gt;</span><span class="si">{</span><span class="n">result1</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;WTF LandfillFeedback Form Structure=&lt;/strong&gt;&lt;/p&gt; &lt;p&gt;</span><span class="si">{</span><span class="n">result2</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;diagnostics.html&#39;</span><span class="p">,</span>
                         <span class="n">header</span><span class="o">=</span><span class="s2">&quot;WTForms Feedback Form Structure&quot;</span><span class="p">,</span>
                         <span class="n">subheader</span><span class="o">=</span><span class="s2">&quot;Inspecting field mappings in Oil &amp; Gas and Landfill feedback forms.&quot;</span><span class="p">,</span>
                         <span class="n">html_content</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                         <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.show_log_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_log_file</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Display the last N lines of the portal log file.</p>
<p>NOTE: This is a developer-only route, not covered by E2E tests by design.</p>


<details class="query-parameters" open>
  <summary>Query Parameters</summary>
  <p>lines (int, optional): Number of lines to show from the end of the log file.
                       Defaults to 1000 if not provided or invalid.</p>
</details>        <p>Args:
  None</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML with the log file content shown inside a <pre> block.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="example-usage" open>
  <summary>Example Usage</summary>
  <p>/show_log_file?lines=500</p>
</details>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Useful for debugging in development or staging.</li>
<li>Efficient for large files using read_file_reverse().</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/show_log_file&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_log_file</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Display the last N lines of the portal log file.</span>

<span class="sd">  NOTE: This is a developer-only route, not covered by E2E tests by design.</span>

<span class="sd">  Query Parameters:</span>
<span class="sd">    lines (int, optional): Number of lines to show from the end of the log file.</span>
<span class="sd">                           Defaults to 1000 if not provided or invalid.</span>
<span class="sd">  Args:</span>
<span class="sd">    None</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML with the log file content shown inside a &lt;pre&gt; block.</span>

<span class="sd">  Example Usage:</span>
<span class="sd">    /show_log_file?lines=500</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Useful for debugging in development or staging.</span>
<span class="sd">    - Efficient for large files using read_file_reverse().</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: show_log_file&quot;</span><span class="p">)</span>

  <span class="n">default_lines</span> <span class="o">=</span> <span class="mi">1000</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">default_lines</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">num_lines</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span>
  <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="n">default_lines</span>

  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying the last </span><span class="si">{</span><span class="n">num_lines</span><span class="si">}</span><span class="s2"> lines of the log file as a diagnostic&quot;</span><span class="p">)</span>

  <span class="n">lines</span> <span class="o">=</span> <span class="n">read_file_reverse</span><span class="p">(</span><span class="n">LOG_FILE</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">num_lines</span><span class="p">)</span>
  <span class="n">file_content</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

  <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;Last </span><span class="si">{</span><span class="n">num_lines</span><span class="si">}</span><span class="s2"> lines of logger file:&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;pre&gt;</span><span class="si">{</span><span class="n">file_content</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&lt;/p&gt;&quot;</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
    <span class="s1">&#39;diagnostics.html&#39;</span><span class="p">,</span>
    <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Log File Contents&quot;</span><span class="p">,</span>
    <span class="n">html_content</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.upload_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">upload_file</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Handle file upload form and process uploaded Excel files.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>message</code></b>
                  (<code><span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Optional message to display on the upload page.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="flask.Response">Response</span>]</code>
              –
              <div class="doc-md-description">
                <p>str|Response: Rendered HTML for the upload form, or redirect after upload.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.upload_file--in-browser-get-upload">In browser: GET /upload</h3>
<h3 id="arb.portal.routes.upload_file--returns-html-upload-form">Returns: HTML upload form</h3>
<h3 id="arb.portal.routes.upload_file--in-browser-post-upload">In browser: POST /upload</h3>
<h3 id="arb.portal.routes.upload_file--redirects-to-list_uploads-or-error-page">Redirects to: /list_uploads or error page</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/upload&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/upload/&lt;message&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_file</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Response</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Handle file upload form and process uploaded Excel files.</span>

<span class="sd">  Args:</span>
<span class="sd">    message (str | None): Optional message to display on the upload page.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str|Response: Rendered HTML for the upload form, or redirect after upload.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /upload</span>
<span class="sd">    # Returns: HTML upload form</span>
<span class="sd">    # In browser: POST /upload</span>
<span class="sd">    # Redirects to: /list_uploads or error page</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: upload_file with message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">form</span> <span class="o">=</span> <span class="n">UploadForm</span><span class="p">()</span>

  <span class="c1"># Decode redirect message, if present</span>
  <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received redirect message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">upload_folder</span> <span class="o">=</span> <span class="n">get_upload_folder</span><span class="p">()</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Files received: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">, upload_folder=</span><span class="si">{</span><span class="n">upload_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">request_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">request_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request_file</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;POST received with no file selected.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
          <span class="s1">&#39;upload.html&#39;</span><span class="p">,</span>
          <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
          <span class="n">upload_message</span><span class="o">=</span><span class="s2">&quot;No file selected. Please choose a file.&quot;</span>
        <span class="p">)</span>

      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received uploaded file: </span><span class="si">{</span><span class="n">request_file</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="c1"># Step 1: Save file and attempt DB ingest</span>
      <span class="n">file_path</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">upload_and_update_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">upload_folder</span><span class="p">,</span> <span class="n">request_file</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">id_</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload successful: id=</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">, sector=</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">. Redirecting to update page.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.incidence_update&#39;</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">id_</span><span class="p">))</span>

      <span class="c1"># If id_ is None, check if likely blocked due to missing/invalid id_incidence</span>
      <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Check log message or just show the message if id_ is None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload blocked: missing or invalid id_incidence in </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
          <span class="s1">&#39;upload.html&#39;</span><span class="p">,</span>
          <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
          <span class="n">upload_message</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;This file is missing a valid &#39;Incidence/Emission ID&#39; (id_incidence). &quot;</span>
            <span class="s2">&quot;Please add a positive integer id_incidence to your spreadsheet before uploading.&quot;</span>
          <span class="p">)</span>
        <span class="p">)</span>

      <span class="c1"># Step 2: Handle schema recognition failure with enhanced diagnostics</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload failed schema recognition: </span><span class="si">{</span><span class="n">file_path</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">error_details</span> <span class="o">=</span> <span class="n">generate_upload_diagnostics</span><span class="p">(</span><span class="n">request_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
      <span class="n">detailed_message</span> <span class="o">=</span> <span class="n">format_diagnostic_message</span><span class="p">(</span><span class="n">error_details</span><span class="p">,</span>
                                                   <span class="s2">&quot;Uploaded file format not recognized.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;upload.html&#39;</span><span class="p">,</span>
        <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
        <span class="n">upload_message</span><span class="o">=</span><span class="n">detailed_message</span>
      <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred during upload or parsing.&quot;</span><span class="p">)</span>

      <span class="c1"># Enhanced error handling with diagnostic information</span>
      <span class="n">error_details</span> <span class="o">=</span> <span class="n">generate_upload_diagnostics</span><span class="p">(</span><span class="n">request_file</span><span class="p">,</span>
                                                  <span class="n">file_path</span> <span class="k">if</span> <span class="s1">&#39;file_path&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
      <span class="n">detailed_message</span> <span class="o">=</span> <span class="n">format_diagnostic_message</span><span class="p">(</span><span class="n">error_details</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;upload.html&#39;</span><span class="p">,</span>
        <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
        <span class="n">upload_message</span><span class="o">=</span><span class="n">detailed_message</span>
      <span class="p">)</span>

  <span class="c1"># GET request: display form</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;upload.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">upload_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.upload_file_staged" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">upload_file_staged</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Handle staged file upload form and process staged Excel files.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>message</code></b>
                  (<code><span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Optional message to display on the staged upload page.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="flask.Response">Response</span>]</code>
              –
              <div class="doc-md-description">
                <p>str|Response: Rendered HTML for the staged upload form, or redirect after upload.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="arb.portal.routes.upload_file_staged--in-browser-get-upload_staged">In browser: GET /upload_staged</h3>
<h3 id="arb.portal.routes.upload_file_staged--returns-html-staged-upload-form">Returns: HTML staged upload form</h3>
<h3 id="arb.portal.routes.upload_file_staged--in-browser-post-upload_staged">In browser: POST /upload_staged</h3>
<h3 id="arb.portal.routes.upload_file_staged--redirects-to-list_staged-or-error-page">Redirects to: /list_staged or error page</h3>


            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/upload_staged&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/upload_staged/&lt;message&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_file_staged</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Response</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Handle staged file upload form and process staged Excel files.</span>

<span class="sd">  Args:</span>
<span class="sd">    message (str | None): Optional message to display on the staged upload page.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str|Response: Rendered HTML for the staged upload form, or redirect after upload.</span>

<span class="sd">  Examples:</span>
<span class="sd">    # In browser: GET /upload_staged</span>
<span class="sd">    # Returns: HTML staged upload form</span>
<span class="sd">    # In browser: POST /upload_staged</span>
<span class="sd">    # Redirects to: /list_staged or error page</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route called: upload_file_staged with message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">base</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">base</span>  <span class="c1"># type: ignore[attr-defined]</span>
  <span class="n">form</span> <span class="o">=</span> <span class="n">UploadForm</span><span class="p">()</span>

  <span class="c1"># Decode optional redirect message</span>
  <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received redirect message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">upload_folder</span> <span class="o">=</span> <span class="n">get_upload_folder</span><span class="p">()</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request received with files: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">, upload_folder=</span><span class="si">{</span><span class="n">upload_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">request_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">request_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request_file</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;POST received with no file selected.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;upload_staged.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">upload_message</span><span class="o">=</span><span class="s2">&quot;No file selected. Please choose a file.&quot;</span><span class="p">)</span>

      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received uploaded file: </span><span class="si">{</span><span class="n">request_file</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="c1"># Save and stage (no DB commit)</span>
      <span class="n">file_path</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">json_data</span><span class="p">,</span> <span class="n">staged_filename</span> <span class="o">=</span> <span class="n">upload_and_stage_only</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">upload_folder</span><span class="p">,</span> <span class="n">request_file</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">id_</span> <span class="ow">and</span> <span class="n">staged_filename</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Staged upload successful: id=</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">, sector=</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">, filename=</span><span class="si">{</span><span class="n">staged_filename</span><span class="si">}</span><span class="s2">. Redirecting to review page.&quot;</span><span class="p">)</span>
        <span class="c1"># Enhanced success feedback with staging details</span>
        <span class="n">success_message</span> <span class="o">=</span> <span class="p">(</span>
          <span class="sa">f</span><span class="s2">&quot;✅ File &#39;</span><span class="si">{</span><span class="n">request_file</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39; staged successfully!</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;📋 ID: </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;🏭 Sector: </span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;📁 Staged as: </span><span class="si">{</span><span class="n">staged_filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;🔍 Ready for review and confirmation.&quot;</span>
        <span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">success_message</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.review_staged&#39;</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">staged_filename</span><span class="p">))</span>

      <span class="c1"># If id_ is None or not staged, check if likely blocked due to missing/invalid id_incidence</span>
      <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Staging blocked: missing or invalid id_incidence in </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
          <span class="s1">&#39;upload_staged.html&#39;</span><span class="p">,</span>
          <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
          <span class="n">upload_message</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;This file is missing a valid &#39;Incidence/Emission ID&#39; (id_incidence). &quot;</span>
            <span class="s2">&quot;Please add a positive integer id_incidence to your spreadsheet before uploading.&quot;</span>
          <span class="p">)</span>
        <span class="p">)</span>

      <span class="c1"># Fallback: schema recognition failure or other error</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Staging failed: missing or invalid id_incidence in </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;upload_staged.html&#39;</span><span class="p">,</span>
        <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
        <span class="n">upload_message</span><span class="o">=</span><span class="s2">&quot;This file is missing a valid &#39;Incidence/Emission ID&#39; (id_incidence). &quot;</span>
                       <span class="s2">&quot;Please verify the spreadsheet includes that field and try again.&quot;</span>
      <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred during staged upload.&quot;</span><span class="p">)</span>

      <span class="c1"># Enhanced error handling with staging-specific diagnostic information</span>
      <span class="n">error_details</span> <span class="o">=</span> <span class="n">generate_staging_diagnostics</span><span class="p">(</span>
        <span class="n">request_file</span><span class="p">,</span>
        <span class="n">file_path</span> <span class="k">if</span> <span class="s1">&#39;file_path&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">staged_filename</span> <span class="k">if</span> <span class="s1">&#39;staged_filename&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">id_</span> <span class="k">if</span> <span class="s1">&#39;id_&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sector</span> <span class="k">if</span> <span class="s1">&#39;sector&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
      <span class="p">)</span>
      <span class="n">detailed_message</span> <span class="o">=</span> <span class="n">format_diagnostic_message</span><span class="p">(</span><span class="n">error_details</span><span class="p">,</span>
                                                   <span class="s2">&quot;Staged upload processing failed.&quot;</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;upload_staged.html&#39;</span><span class="p">,</span>
        <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
        <span class="n">upload_message</span><span class="o">=</span><span class="n">detailed_message</span>
      <span class="p">)</span>

  <span class="c1"># GET request: display form</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;upload_staged.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">upload_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="arb.portal.routes.view_portal_updates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_portal_updates</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Display a table of all portal update log entries.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>str</code></b>(                  <code><span title="str">str</span></code>
)              –
              <div class="doc-md-description">
                <p>Rendered HTML table of portal update logs.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Supports pagination, filtering, and sorting via query parameters.</li>
<li>Default sort is descending by timestamp.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>arb\portal\routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@main</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/portal_updates&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_portal_updates</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Display a table of all portal update log entries.</span>

<span class="sd">  Returns:</span>
<span class="sd">    str: Rendered HTML table of portal update logs.</span>

<span class="sd">  Notes:</span>
<span class="sd">    - Supports pagination, filtering, and sorting via query parameters.</span>
<span class="sd">    - Default sort is descending by timestamp.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">sort_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort_by&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
  <span class="n">direction</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">)</span>
  <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">per_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;per_page&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

  <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PortalUpdate</span><span class="p">)</span>
  <span class="n">query</span> <span class="o">=</span> <span class="n">apply_portal_update_filters</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">PortalUpdate</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

  <span class="n">updates</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">PortalUpdate</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
    <span class="s2">&quot;portal_updates.html&quot;</span><span class="p">,</span>
    <span class="n">updates</span><span class="o">=</span><span class="n">updates</span><span class="p">,</span>
    <span class="n">sort_by</span><span class="o">=</span><span class="n">sort_by</span><span class="p">,</span>
    <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span>
    <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
    <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span><span class="p">,</span>
    <span class="n">total_pages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">filter_key</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filter_key&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
    <span class="n">filter_user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filter_user&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
    <span class="n">filter_comments</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filter_comments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
    <span class="n">filter_id_incidence</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filter_id_incidence&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_date&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
    <span class="n">end_date</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_date&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../json_update_util/" class="btn btn-neutral float-left" title="arb.portal.json_update_util"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../sqla_models/" class="btn btn-neutral float-right" title="arb.portal.sqla_models">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../json_update_util/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../sqla_models/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
